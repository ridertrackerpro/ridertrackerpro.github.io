<!DOCTYPE html>
<html lang="it" id="htmlRoot">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0f0f0f">
    <title>RIDER TRACKER PRO V 2.0</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
window.onerror = function(message, source, lineno, colno, error) {
    alert("JS ERROR:\n\n" + message + "\nLine: " + lineno);
};
    </script>
    <style>
        :root { --bg:#0f0f0f; --card:#1a1a1a; --primary:#00CCBC; --accent:#ff4d4d; --text:#e0e0e0; --dim:#888; --input-bg:#252525; --orange:#ffa500; --red-soft:#8b0000; }
        :root {
  --vh: 100dvh;
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}

* { box-sizing:border-box; -webkit-tap-highlight-color:transparent; touch-action: manipulation; }
        html { background:var(--bg); }
        body { font-family:sans-serif; background:var(--bg); color:var(--text); margin:0; padding:0; text-align:center; height: 100vh; width: 100vw; position: fixed; inset: 0; display: flex; align-items: flex-start; justify-content: flex-start; overflow: hidden; }
        
        button, .foot-btn, .btn-full, .btn-modal, .btn-option, .clickable { cursor: pointer; -webkit-user-select: none; user-select: none; }
        @media all and (display-mode: standalone) {
            body { align-items: center; justify-content: center; margin-top: 24px; }
            #mainContainer { max-height: 100vh; }
        }
        
        #mainContainer {
    width: 100%;
    max-width: 100%;
    margin: 0;
    padding: 10px 10px 12px 10px;
    box-sizing: border-box;

    overflow-y: auto;
    overflow-x: hidden;
        }

        .foot-btn:active, .btn-full:active { transform: scale(0.95); transition: 0.1s; }
        .app-title { margin:10px 0 15px; font-size:30px; font-weight:800; color:var(--primary); text-transform:uppercase; user-select:none; cursor: pointer; }
        .grid { display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-bottom:8px; }
        .card { background:var(--card); height:75px; display:flex; flex-direction:column; justify-content:center; align-items:center; border-radius:12px; border:1px solid #333; }
        .label { font-size:8px; color:var(--dim); text-transform:uppercase; margin-bottom:4px; font-weight:bold; }
        .val { font-size:14px; font-weight:bold; }
        .card.main .val, #lordo, #mancante { color:var(--primary)!important; } 
        #netto { color:var(--accent)!important; }
        .card input { width:80%; background:transparent; border:none; border-bottom:1px solid #444; color:#fff; text-align:center; font-size:14px; outline:none; }
        .progress-container { background:var(--card); padding:15px; border-radius:15px; margin-top: 0; margin-bottom:8px; border:1px solid #333; display: flex; flex-direction: column; gap: 8px; }
        .progress-header { display:flex; justify-content:center; font-weight:bold; color:var(--primary); font-size:14px; text-transform: uppercase; letter-spacing: 1px; }
        .progress-bar { background:#222; height:28px; border-radius:8px; overflow:hidden; border:1px solid #444; }
        #bar { background:linear-gradient(90deg, var(--primary), #ccff00); height:100%; width:0%; transition:0.3s; }
        .dash-info { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; margin-top: 5px; }
        #liveClock { font-weight:bold; color:var(--dim); font-size:11px; text-transform: uppercase; }
        #mediaOraria { font-weight:bold; color:var(--primary); font-size:12px; }
        .sticky-footer {
    position:relative;
    margin-top:0;
    background:#161616;
    padding:12px 15px 12px 15px;
    display:grid;
    grid-template-columns:repeat(4, 1fr);
    gap:8px;
    border-radius:25px;
    border:1px solid #333;
    z-index:1000;
    margin-bottom:0;
}
.foot-btn { background:#222; border:1px solid #444; color:#fff; padding:12px 5px; border-radius:15px; display:flex; flex-direction:column; align-items:center; font-size:10px; font-weight: bold; }
        .foot-btn i { font-size:20px; margin-bottom:5px; }
        .btn-full {
  grid-column:span 4;
  background:var(--primary);
  color:#000;
  padding:16px;
  border-radius:15px;
  font-weight:900;
  border:none;
  font-size:13px;
  text-transform:uppercase;

  margin-top: 8px;
  margin-bottom: 8px;
}
        .btn-reset-soft {
    grid-column: span 4;
    background: var(--red-soft);
    color: #ccc;
    border: none;
    padding: 10px;
    border-radius: 12px;
    font-weight: bold;
    font-size: 10px;
    margin-top: 8px;
    text-transform: uppercase;
        }
        .report-fixed-footer { padding: 15px; padding-bottom: 45px; border-top: 1px solid #eee; background: #fff; }
        .backup-grid, .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 10px; }
        .btn-rep-uniform { width: 100%; padding: 10px 5px; border-radius: 10px; font-weight: 700; text-transform: uppercase; font-size: 10px; display: flex; align-items: center; justify-content: center; gap: 6px; cursor: pointer; border: 1.5px solid transparent; transition: 0.2s; }
        .btn-grey-light { background: #f8f8f8; color: #555; border-color: #ddd; }
        .btn-black { background: #1a1a1a; color: #fff; }
        .btn-grey-dark { background: #666; color: #fff; }
        .btn-rep-uniform i { font-size: 12px; }
        .modal { display:none; position:fixed; inset:0; z-index:9999; background:rgba(0,0,0,0.6); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); align-items: center; justify-content: center; }
       .modal-content { background:var(--card); padding:20px; border-radius:24px; width:90%; max-width:320px; border:2px solid var(--primary); margin: auto; transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 10px 30px rgba(0,0,0,0.5); overflow: hidden; }
        .modal h3 { margin-top: 0; font-size: 18px; color: var(--primary); text-transform: uppercase; }
        .modal input { width:100%; padding:12px; background:var(--input-bg); border:1px solid #444; color:#fff; border-radius:12px; margin-bottom:10px; outline:none; font-size: 16px; }
        #histView { display:none; position:fixed; inset:0; z-index:9000; background:var(--bg); flex-direction: column; padding: 15px; }
        #listaStorico { flex-grow: 1; overflow-y: auto; margin-bottom: 15px; border-top: 1px solid #333; border-bottom: 1px solid #333; -webkit-overflow-scrolling: touch; }
        #reportView { display:none; position:fixed; inset:0; z-index:8000; background:#fff; color:#000; flex-direction:column; text-align:left; }
#chartOra, #chartKm { min-height: 200px; }
        .report-scroll-area { flex: 1; overflow-y: auto; padding: 10px; -webkit-overflow-scrolling: touch; }
        .report-header-mini { border-bottom:2px solid #000; padding-bottom:10px; margin-bottom:15px; text-align: center; }
        .report-header-mini h2 { font-size:16px; margin:0; text-transform:uppercase; color: #000; letter-spacing: 1px; }
  .report-table { 
    width: 100%; 
    border-collapse: collapse; 
    font-size: 9px; 
    margin-bottom: 15px; 
    table-layout: auto;
}
.report-table td, .report-table th { 
    padding: 3px 2px;
    white-space: nowrap;
    border: 1px solid #000;
    text-align: center;
}
        .report-table th { background: #eee; font-weight: bold; }
        .summary-box { border:2px solid #000; padding:10px; background:#fff; }
        .summary-row { display:flex; justify-content:space-between; padding:4px 0; font-size:11px; color: #000; }
        .summary-row.total { font-weight:bold; font-size:14px; border-top:2px solid #000; margin-top:5px; padding-bottom: 10px; }
       .storico-item { background:#0f0f0f; padding:15px 5px; border-top:1px solid #333; border-bottom:1px solid #333; border-radius:12px; display:flex; justify-content:space-between; align-items:center; margin-bottom: 5px; position: relative; }
        .storico-info { flex:1; text-align:left; padding: 0 10px; }
        .tipo-label { font-size:9px; font-weight:900; text-transform:uppercase; letter-spacing:1.5px; display: flex; align-items: center; gap: 5px; }
        .storico-date-row { display: flex; align-items: baseline; gap: 8px; font-weight: bold; font-size: 14px; margin-top: 2px; }
        .storico-hour { color: var(--dim); font-size: 11px; font-weight: normal; }
        .storico-main { font-size:18px; font-weight:bold; margin-top: 2px; }
        .storico-sub { font-size:10px; color:var(--dim); line-height: 1.4; }
        .btn-modal { width:100%; padding:14px; border-radius:12px; border:none; font-weight:bold; margin-top:8px; font-size: 15px; }
        .btn-save { background:var(--primary); color:#000; }
        .btn-close { background:#333; color:#fff; }
        .confirm-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .btn-confirm-ok { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: bold; font-size: 14px; }
        .btn-confirm-cancel { background: #333; color: white; flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: bold; font-size: 14px; }
        .date-row { display:flex; gap:8px; margin-bottom:10px; }
        .date-row select { background:#333; color:#fff; padding:10px; border-radius:10px; flex:1; border:1px solid #444; font-size: 14px; } 
        #repEfficienzaBody td:nth-child(2), #repEfficienzaBody td:nth-child(4) { width: 1%; }
        .tipo-abbrev-mi { font-size: 6px; }
        .btn-option { width: 100%; padding: 15px; background: #252525; border: 1px solid #444; color: #fff; border-radius: 12px; font-size: 16px; text-align: left; cursor: pointer; display: flex; align-items: center; gap: 15px; transition: 0.2s; }
        .btn-option i { font-size: 20px; width: 25px; text-align: center; }
        .btn-option:active { background: var(--primary); color: #000; border-color: var(--primary); transform: scale(0.98); }
        .fake-select { width: 100%; padding: 12px; background: #252525; color: #fff; border-radius: 12px; border: 1px solid #444; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 16px; }
        
.month-group {
  background: #0f0f0f;
  border: 1px solid #333;
  border-radius: 14px;
  margin-bottom: 8px;
  overflow: hidden;
}
.month-header {
  padding: 12px 14px;
  background: linear-gradient(180deg, #2a2a2a, #181818);
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  border-bottom: 1px solid #111;
  box-shadow: 
    inset 0 1px 0 rgba(255,255,255,0.08),
    inset 0 -1px 0 rgba(0,0,0,0.6);
  transition: transform 0.2s ease;
}

.month-header:active {
  transform: translateY(1px);
}

.month-title {
  font-weight: 900;
  color: #fff;
  text-transform: uppercase;
  font-size: 12px;
  letter-spacing: 1px;
}

.month-summary {
  font-size: 10px;
  color: #aaa;
  margin-top: 4px;
}

.month-actions {
  display: flex;
  align-items: center;
  gap: 15px;
}

.month-chevron {
  transition: 0.3s;
}

.month-body {
  max-height: 0;
  overflow: hidden;
  padding: 0;
  background: linear-gradient(180deg, #101010, #0b0b0b);
  border-top: 1px solid rgba(255,255,255,0.03);
  transform: translateY(-8px);
  opacity: 0;
  transition:
    max-height 0.35s ease,
    padding 0.3s ease,
    transform 0.35s cubic-bezier(0.22, 1, 0.36, 1),
    opacity 0.25s ease;
}

.month-body.open {
  max-height: 5000px;
  padding: 8px 0;
  transform: translateY(0);
  opacity: 1;
}

.btn-del-month {
  color: var(--accent);
  background: none;
  border: 1px solid var(--accent);
  border-radius: 5px;
  padding: 4px 8px;
  font-size: 10px;
  font-weight: bold;
  cursor: pointer;
}

.btn-rep-month {
  color: #000;
  background: var(--primary);
  border: none;
  border-radius: 5px;
  padding: 4px 8px;
  font-size: 10px;
  font-weight: bold;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
}
.btn-rep-month:active {
  opacity: 0.7;
}

.clickable { cursor: pointer; }
.clickable:active { opacity: 0.6; }

@media print { 
    /* Layout pagina */
    html, body { 
        height: auto !important; 
        overflow: visible !important; 
        position: static !important; 
    }
    body * { visibility: hidden; } 
    #reportView, #reportView * { visibility: visible; } 
    .no-print { display: none !important; visibility: hidden !important; } 
    #reportView { position: absolute; left: 0; top: 0; width: 100%; display: block !important; height: auto !important; } 
    .report-scroll-area { overflow: visible !important; height: auto !important; max-height: none !important; } 
    
    /* OGNI CORNICE NON VIENE MAI SPEZZATA */
    .report-section { 
        page-break-inside: avoid !important;
        border: 2px solid #000 !important;
        padding: 15px !important;
        margin-bottom: 20px !important;
        background: #fff !important;
    }
    
    table { page-break-inside: auto; }
    tr { page-break-inside: avoid; page-break-after: auto; }
    
    /* RIEPILOGO FINALE IN CORNICE SEPARATA */
    .summary-box { 
        page-break-inside: avoid !important;
        page-break-before: always !important;
        border: 3px solid #000 !important;
        padding: 20px !important;
        background: #fff !important;
    }
    
    h3 { 
        page-break-after: avoid;
        margin-top: 0 !important;
    }

    /* BIANCO E NERO TOTALE */
    #reportView * {
        color: #000 !important;
        background: #fff !important;
        border-color: #000 !important;
        box-shadow: none !important;
        text-shadow: none !important;
    }

    table, th, td {
        border-color: #000 !important;
        background: #fff !important;
        color: #000 !important;
    }

    th {
        font-weight: bold;
        background: #f0f0f0 !important;
        color: #000 !important;
    }

    h1, h2, h3, h4, h5, h6 {
        color: #000 !important;
    }

    i, svg {
        color: #000 !important;
        fill: #000 !important;
    }

    hr {
        border: none !important;
        border-top: 2px solid #000 !important;
    }

    .summary-row {
        color: #000 !important;
        background: #fff !important;
        border-color: #000 !important;
    }

    span, div, p {
        color: #000 !important;
    }
}

@media (display-mode: standalone) {
    #mainContainer {
        width: 96vw;
        max-width: 96vw;
        margin-top: 15px;
        margin-left: auto;
        margin-right: auto;
        border-radius: 20px;
        background: var(--bg);
        height: calc(100dvh - env(safe-area-inset-bottom, 0px));
        padding-bottom: calc(40px + env(safe-area-inset-bottom, 0px));
        overflow-y: auto;
        overflow-x: hidden;
    }
}

.safe-box{
  grid-column: span 4;
  height:52px;
  border-radius:12px;
  background:linear-gradient(180deg,#2e2e2e,#161616);
  border:1px solid #444;
  box-shadow:
    inset 0 1px 2px rgba(255,255,255,.12),
    inset 0 -2px 4px rgba(0,0,0,.7),
    0 4px 6px rgba(0,0,0,.6);

  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  position:relative;
  cursor:pointer;
  user-select:none;
}

.safe-door{
  position:absolute;
  inset:6px;
  background:#222;
  border-radius:10px;
  transform-origin:left center;
  transition:transform .6s cubic-bezier(.4,0,.2,1);
}

.safe-door.open{
  transform:rotateY(-65deg);
}

.safe-glass{
  position:absolute;
  inset:0;
  background:linear-gradient(135deg,rgba(255,255,255,.18),rgba(255,255,255,.02));
  backdrop-filter:blur(1px);
  border-radius:10px;
}

.safe-lock{
  position:absolute;
  right:10px;
  top:50%;
  transform:translateY(-50%);
  font-size:20px;
  color:var(--accent);
}

.safe-lock.unlock i{
  animation:unlockAnim .1s ease;
}

@keyframes unlockAnim{
  0%{transform:rotate(0)}
  30%{transform:rotate(-12deg)}
  60%{transform:rotate(12deg)}
  100%{transform:rotate(0)}
}

.safe-label{
  position:relative;
  z-index:1;
  font-size:10px;
  font-weight:900;
  letter-spacing:1px;
  color:#ff4d4d;
  text-shadow:0 0 6px rgba(255,77,77,.6);
}
    </style>
</head>
<body>
    <div id="mainContainer">
        <div class="app-title no-print"
       style="display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
              width: 100%;
              margin: 4px 0 10px 0;
              line-height: 1.03;">

    <div onclick="document.getElementById('modalFineMese').style.display = 'flex';"
         style="display: flex;
                align-items: center;
                font-family: sans-serif;
                font-weight: 900;
                font-size: 27px;
                letter-spacing: -0.5px;
                cursor: pointer;">
        <span style="color: var(--primary); text-shadow: 0 0 15px rgba(0,204,188,0.4);">RIDER</span>
        <span style="color: #ffffff; margin-left: 5px;">TRACKER</span>
        <span style="color: var(--bg); background: var(--primary); padding: 2px 6px; border-radius: 5px; margin-left: 7px; font-size: 20px; font-weight: 900;">PRO</span>
    </div>

    <div style="display: flex;
                align-items: center;
                gap: 8px;
                margin-top: 6px;
                font-weight: bold;
                text-transform: uppercase;
                font-size: 9px;
                letter-spacing: 1px;">
        <span style="color: var(--dim);">VERSION 2.0</span>
        <span style="color: #444;">|</span>
        <span style="color: var(--dim);">
            ¬© 2026 by
            <a href="https://facebook.com/madmaddj"
               target="_blank"
               style="color: var(--primary); text-decoration: none; border-bottom: 1px solid rgba(0,204,188,0.2);">
                MARCO CARBONE
            </a>
        </span>
    </div>

    <div style="display: flex;
                align-items: center;
                gap: 14px;
                margin-top: 6px;">
        <span id="btnSettings"
              onclick="apriModalSettings()"
              style="font-size: 20px; cursor: pointer; transition: 0.2s; opacity: 0.7; line-height:1;"
              title="Settings">‚öôÔ∏è</span>
        <span id="flagIT"
              onclick="apriLanguageIT()"
              style="font-size: 22px; cursor: pointer; transition: 0.2s; opacity: 1;"
              title="Italiano">üáÆüáπ</span>
        <span id="flagEN"
              onclick="apriLanguageEN()"
              style="font-size: 22px; cursor: pointer; transition: 0.2s; opacity: 0.4;"
              title="English">üá∫üá∏</span>
    </div>

  </div>
      <div class="grid">
    <div class="card main">
        <div class="label" data-translate="gross_earned">LORDO GUADAGNATO</div>
        <div class="val" id="lordo">0.00</div>
    </div>

    <div class="card main">
        <div class="label" data-translate="net_earned">NETTO GUADAGNATO</div>
        <div class="val" id="netto">0.00</div>
    </div>

    <div class="card">
        <div class="label" data-translate="hours_tot">ORE TOT LAVORO</div>
        <div class="val" id="ore">0.0</div>
    </div>

    <div class="card">
        <div class="label" data-translate="consumption">Q.T√Ä CONSUMO</div>
        <div class="val" id="cons">0.0L</div>
    </div>

    <div class="card">
        <div class="label" data-translate="avg_consumption">MEDIA CONSUMI</div>
        <div class="val" id="kml">0.0</div>
    </div>

    <div class="card">
        <div class="label" data-translate="fuel_cost">SPESA CARBURANTE</div>
        <div class="val" id="spesaB">0.00</div>
    </div>
</div>
<div class="grid">
    <div class="card"><div class="label" data-translate="net_target">OBIETTIVO NETTO</div><input id="targetIn" type="number" inputmode="decimal" oninput="aggiornaTarget()"></div>
    <div class="card"><div class="label" data-translate="taxation">TASSAZIONE %</div><input id="taxIn" type="number" inputmode="decimal" oninput="aggiornaTax()"></div>
    <div class="card main"><div class="label" data-translate="gross_missing">LORDO MANCANTE</div><div class="val" id="mancante">0.00</div></div>    
</div>
<div class="progress-container">

    <div class="progress-header" id="perc">0%</div>
    <div class="progress-bar"><div id="bar"></div></div>
    <div class="dash-info">
        <div id="liveClock">00/00/00 00:00:00</div>
        <div id="mediaOraria">0.00</div>
    </div>
</div>
<div id="modalTurno" class="modal no-print">
    <div class="modal-content" style="border-color: var(--primary);">
        <h3 data-translate="new_shift">Nuovo Turno</h3>
        <div id="dateT" class="date-row"></div>
        <div class="fake-select" onclick="document.getElementById('modalSelectMezzo').style.display='flex'">
            <span id="labelMezzo">üöó Auto</span>
            <i class="fas fa-chevron-down"></i>
        </div>
        <input type="hidden" id="tMezzo" value="auto">
        <div class="fake-select" onclick="document.getElementById('modalSelectCarburanteTurno').style.display='flex'">
            <span id="labelCarburanteTurno">‚õΩ Benzina</span>
            <i class="fas fa-chevron-down"></i>
        </div>
        <input type="hidden" id="tCarburante" value="benzina">
        <input type="number" id="tL" data-translate-placeholder="ph_gross_earned" inputmode="decimal" autocomplete="off">
        <input type="number" id="tO" data-translate-placeholder="ph_hours" step="0.1" inputmode="decimal" autocomplete="off">
        <input type="number" id="tK" data-translate-placeholder="ph_km" inputmode="decimal" autocomplete="off">
        <input type="number" id="tC" data-translate-placeholder="ph_cons_l" step="0.1" inputmode="decimal" autocomplete="off">
        <div id="consHint" style="font-size:11px; color:var(--primary); margin:-8px 0 8px 2px; min-height:14px; font-style:italic;"></div>
        <button class="btn-modal btn-save" onclick="salvaTurno()" data-translate="save">SALVA</button>
        <button class="btn-modal btn-close" onclick="chiudiModali()" data-translate="cancel">ANNULLA</button>
    </div>
</div>

<div id="modalSelectMezzo" class="modal no-print">
    <div class="modal-content">
        <h3 data-translate="select_vehicle">SELEZIONA MEZZO</h3>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <button class="btn-option" onclick="selezionaMezzo('auto')">
    <span>üöó</span> <span data-translate="vehicle_car">Auto</span>
</button>

<button class="btn-option" onclick="selezionaMezzo('moto')">
    <span>üèçÔ∏è</span> <span data-translate="vehicle_motorcycle">Moto</span>
</button>

<button class="btn-option" onclick="selezionaMezzo('escooter')">
    <span>‚ö°</span> <span data-translate="vehicle_escooter">Bici elettrica</span>
</button>

<button class="btn-option" onclick="selezionaMezzo('bici')">
    <span>üö≤</span> <span data-translate="vehicle_bike">Bici</span>
</button>

<button class="btn-option" onclick="selezionaMezzo('scooter')">
    <span>üõ¥</span> <span data-translate="vehicle_scooter">Monopattino</span>
</button>
        </div>
        <button class="btn-modal btn-close" onclick="document.getElementById('modalSelectMezzo').style.display='none'" data-translate="cancel">ANNULLA</button>
    </div>
</div>

<div id="modalSelectCarburanteTurno" class="modal no-print">
    <div class="modal-content">
        <h3 data-translate="select_fuel">SELEZIONA CARBURANTE</h3>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="btn-option" onclick="selezionaCarburanteTurno('benzina', '‚õΩ Benzina')">
                <span>‚õΩ</span> <span data-translate="fuel_gas">Benzina</span>
            </button>
            <button class="btn-option" onclick="selezionaCarburanteTurno('diesel', 'üõ¢Ô∏è Gasolio')">
                <span>üõ¢Ô∏è</span> <span data-translate="fuel_diesel">Gasolio</span>
            </button>
            <button class="btn-option" onclick="selezionaCarburanteTurno('gpl', 'üîµ GPL')">
                <span>üîµ</span> GPL
            </button>
            <button class="btn-option" onclick="selezionaCarburanteTurno('metano', 'üí® Metano')">
                <span>üí®</span> <span data-translate="fuel_cng">Metano</span>
            </button>
            <button class="btn-option" onclick="selezionaCarburanteTurno('miscela', 'üîÄ Miscela')">
                <span>üîÄ</span> <span data-translate="fuel_mix">Miscela</span>
            </button>
        </div>
        <button class="btn-modal btn-close" onclick="document.getElementById('modalSelectCarburanteTurno').style.display='none'" data-translate="cancel">ANNULLA</button>
    </div>
</div>

<div id="modalBenza" class="modal no-print">
    <div class="modal-content" style="border-color: var(--orange);">
        <h3 data-translate="refuel">Rifornimento</h3>
        <div id="dateB" class="date-row"></div>
        <div class="fake-select" onclick="document.getElementById('modalSelectCarburante').style.display='flex'">
            <span id="labelCarburante">‚õΩ Benzina</span>
            <i class="fas fa-chevron-down"></i>
        </div>
        <input type="hidden" id="bTipo" value="benzina">
        <input type="number" id="bE" data-translate-placeholder="ph_spent" step="0.01" inputmode="decimal" autocomplete="off">
        <input type="text" id="bP" data-translate-placeholder="insert_ph" inputmode="decimal" oninput="formattaPrezzo(this)" autocomplete="off">
        <div id="campiMiscela" style="display:none;">
            <p style="font-size: 11px; color: var(--dim); margin: 5px 0 10px; text-transform: uppercase;" data-translate="mix_data">DATI MISCELA:</p>
            <input type="number" id="bPercMiscela" data-translate-placeholder="ph_mix_pct" step="0.1" style="margin-bottom:10px;">
            <input type="text" id="bPrezzoOlio" data-translate-placeholder="ph_oil_price" inputmode="decimal" oninput="formattaPrezzo(this)">
        </div>
        <button class="btn-modal btn-save" onclick="salvaBenza()" data-translate="save">SALVA</button>
        <button class="btn-modal btn-close" onclick="chiudiModali()" data-translate="cancel">ANNULLA</button>
    </div>
</div>

<div id="modalSelectCarburante" class="modal no-print">
    <div class="modal-content">
        <h3 data-translate="select_fuel">SELEZIONA CARBURANTE</h3>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="btn-option" onclick="selezionaCarburante('benzina', '‚õΩ Benzina')">
                <span>‚õΩ</span> <span data-translate="fuel_gas">Benzina</span>
            </button>
            <button class="btn-option" onclick="selezionaCarburante('diesel', 'üõ¢Ô∏è Gasolio')">
                <span>üõ¢Ô∏è</span> <span data-translate="fuel_diesel">Gasolio</span>
            </button>
            <button class="btn-option" onclick="selezionaCarburante('gpl', 'üîµ GPL')">
                <span>üîµ</span> GPL
            </button>
            <button class="btn-option" onclick="selezionaCarburante('metano', 'üí® Metano')">
                <span>üí®</span> <span data-translate="fuel_cng">Metano</span>
            </button>
            <button class="btn-option" onclick="selezionaCarburante('miscela', 'üîÄ Miscela')">
                <span>üîÄ</span> <span data-translate="fuel_mix">Miscela</span>
            </button>
        </div>
        <button class="btn-modal btn-close" onclick="document.getElementById('modalSelectCarburante').style.display='none'" data-translate="cancel">ANNULLA</button>
    </div>
</div>

<div id="modalExtra" class="modal no-print">
    <div class="modal-content" style="border-color: var(--accent);">
        <h3 data-translate="extra_distance">Distanza Extra</h3>
        <div id="dateE" class="date-row"></div>

<div id="modalSelectCarburanteExtra" class="modal no-print">
    <div class="modal-content">
        <h3 data-translate="select_fuel">SELEZIONA CARBURANTE</h3>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="btn-option" onclick="selezionaCarburanteExtra('benzina', '‚õΩ Benzina')">
                <span>‚õΩ</span> <span data-translate="fuel_gas">Benzina</span>
            </button>
            <button class="btn-option" onclick="selezionaCarburanteExtra('diesel', 'üõ¢Ô∏è Gasolio')">
                <span>üõ¢Ô∏è</span> <span data-translate="fuel_diesel">Gasolio</span>
            </button>
            <button class="btn-option" onclick="selezionaCarburanteExtra('gpl', 'üîµ GPL')">
                <span>üîµ</span> GPL
            </button>
            <button class="btn-option" onclick="selezionaCarburanteExtra('metano', 'üí® Metano')">
                <span>üí®</span> <span data-translate="fuel_cng">Metano</span>
            </button>
            <button class="btn-option" onclick="selezionaCarburanteExtra('miscela', 'üîÄ Miscela')">
                <span>üîÄ</span> <span data-translate="fuel_mix">Miscela</span>
            </button>
        </div>
        <button class="btn-modal btn-close" onclick="document.getElementById('modalSelectCarburanteExtra').style.display='none'" data-translate="cancel">ANNULLA</button>
    </div>
</div>

<div class="fake-select" onclick="document.getElementById('modalSelectCarburanteExtra').style.display='flex'">
    <span id="labelCarburanteExtra">‚õΩ Benzina</span>
    <i class="fas fa-chevron-down"></i>
</div>
<input type="hidden" id="extraCarburanteInput" value="benzina">

<input type="number" id="extraKmInput" data-translate-placeholder="ph_extra_distance" inputmode="decimal" autocomplete="off">
<input type="number" id="extraMediaInput" data-translate-placeholder="ph_avg_consumption" step="0.1" inputmode="decimal" autocomplete="off">
<input type="text" id="extraDescInput" data-translate-placeholder="ph_description_optional" autocomplete="off">

<button class="btn-modal btn-save" onclick="salvaExtraKm()" data-translate="save">SALVA</button>
<button class="btn-modal btn-close" onclick="chiudiModali()" data-translate="cancel">ANNULLA</button>
</div>
</div>
<div id="modalInizio" class="modal no-print">
    <div class="modal-content" style="border-color: var(--orange);">
        <h3 id="titlePrezzoIniziale" data-translate="initial_price">PREZZO INIZIALE</h3>
        <p style="font-size: 12px; color: var(--dim); margin-bottom: 15px;" data-translate="initial_price_msg">Non ho trovato un prezzo precedente. Inserisci il prezzo attuale:</p>
        <input type="text" id="pIniziale" data-translate-placeholder="insert_ph" inputmode="decimal" oninput="formattaPrezzo(this)" style="font-size:16px; padding:12px;">
        
        <div id="campiOlioInizio" style="display:none; margin-top:15px;">
            <p style="font-size: 11px; color: var(--dim); margin-bottom: 10px; text-transform: uppercase;" data-translate="mix_data">DATI MISCELA:</p>
            <input type="number" id="pPercMiscelaInizio" data-translate-placeholder="ph_mix_pct" step="0.1" style="margin-bottom:10px; font-size:16px; padding:12px;">
            <input type="text" id="pOlioInizio" data-translate-placeholder="ph_oil_price" inputmode="decimal" oninput="formattaPrezzo(this)" style="font-size:16px; padding:12px;">
        </div>

        <button class="btn-modal btn-save" onclick="confermaPrezzoIniziale()" data-translate="save_continue">SALVA E CONTINUA</button>
        <button class="btn-modal btn-close" onclick="chiudiModali()" data-translate="cancel">ANNULLA</button>
    </div>
</div>

<div id="modalConfirm" class="modal no-print">
    <div class="modal-content" style="border-color: var(--accent);">
        <h3 style="color: var(--accent); font-size: 16px;" data-translate="confirm_reset">Conferma Reset</h3>
        <p style="font-size: 13px; color: var(--text); margin: 15px 0;" data-translate="reset_msg">Vuoi azzerare tutto il database?</p>
        <div class="confirm-buttons">
            <button class="btn-confirm-cancel" onclick="chiudiModali()" data-translate="cancel">ANNULLA</button>
            <button class="btn-confirm-ok" style="background: var(--accent); color: white;" onclick="confermaReset()">OK</button>
        </div>
    </div>
</div>

<div id="modalFineMese" class="modal no-print">
    <div class="modal-content" style="border-color: var(--primary);">
        <h3 style="font-size: 16px;" data-translate="end_month">üîî FINE MESE</h3>
        <p style="font-size: 13px; color: var(--text); margin: 15px 0;" data-translate="end_month_msg">Il mese √® terminato. Vuoi stampare il Report PDF delle tue attivit√†?</p>
        <div class="confirm-buttons">
            <button class="btn-confirm-cancel" onclick="chiudiModali()" data-translate="close">CHIUDI</button>
            <button class="btn-confirm-ok" style="background: var(--primary); color: #000;" onclick="stampaDirettaDaAlert()" data-translate="print_now">STAMPA ORA</button>
        </div>
    </div>
</div>
<div id="modalElimina" class="modal no-print">
    <div class="modal-content" style="border-color: var(--accent);">
        <h3 style="color: var(--accent); font-size: 16px;" data-translate="confirm_delete">Conferma Eliminazione</h3>
        <p style="font-size: 13px; color: var(--text); margin: 15px 0;" data-translate="delete_msg">Sei sicuro di voler eliminare?</p>
        <div class="confirm-buttons">
            <button class="btn-confirm-cancel" onclick="resetModaleElimina()" data-translate="cancel">ANNULLA</button>
            <button id="btnConfermaElimina" class="btn-confirm-ok" style="background: var(--accent); color: white;" data-translate="delete">ELIMINA</button>
        </div>
    </div>
</div>

<div id="modalBackupExport" class="modal no-print">
    <div class="modal-content" style="border-color: var(--primary);">
        <h3 style="font-size: 16px;" data-translate="backup_title">üì¶ BACKUP DISPONIBILE</h3>
        <p style="font-size: 13px; color: var(--text); margin: 15px 0;" data-translate="backup_msg">I tuoi dati sono stati modificati. Vuoi scaricare un backup di sicurezza?</p>
        <div class="confirm-buttons">
            <button class="btn-confirm-cancel" onclick="rifiutaBackup()" data-translate="not_now">NON ORA</button>
            <button class="btn-confirm-ok" style="background: var(--primary); color: #000;" onclick="accettaBackup()" data-translate="download">SCARICA</button>
        </div>
    </div>
</div>

<div id="modalMulti" class="modal no-print">
    <div class="modal-content" style="border-color: var(--primary);">
        <h3 id="multiTitle" style="font-size: 16px;"></h3>
        <div id="multiBody" style="font-size: 14px; color: var(--text); margin: 15px 0;"></div>
        <button class="btn-modal btn-close" onclick="document.getElementById('modalMulti').style.display='none'" data-translate="close">CHIUDI</button>
    </div>
</div>

<div id="histView" class="no-print">
    <div style="background: var(--card); border-radius: 15px; padding: 15px; border: 1px solid #444; box-shadow: 0 5px 15px rgba(0,0,0,0.3); margin-bottom: 15px;">
        <h2 style="margin: 0 0 10px; font-size: 18px; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; text-align: center;" data-translate="history">STORICO</h2>
    </div>
    <div id="listaStorico"></div>
    <button class="btn-full" onclick="document.getElementById('histView').style.display='none'" style="margin-bottom: 25px; padding: 15px;"><i class="fas fa-times"></i> <span data-translate="close">CHIUDI</span></button>
</div>
<div id="reportView">
<div class="report-scroll-area">
<div style="padding:15px;">

<h2 style="text-align:center; font-size:18px; margin-bottom:20px;">
<span data-translate="report_title">RIEPILOGO MESE DI</span>
<span id="reportMeseLabel"></span>
</h2>

<!-- DETTAGLIO TURNI -->
<div class="report-section">
<h3 style="font-size:16px; margin-bottom:10px;" data-translate="detail_shifts">DETTAGLIO TURNI</h3>
<table class="report-table">
<thead>
<tr>
<th data-translate="col_date">DATA</th>
<th data-translate="col_gross">LORDO</th>
<th data-translate="col_net">NETTO</th>
<th data-translate="col_hours">ORE</th>
<th id="thDistanzaTurni">KM</th>
<th id="thConsumoTurni">C/100</th>
<th data-translate="col_type_abbr">T</th>
<th data-translate="col_qty_abbr">QTA</th>
</tr>
</thead>
<tbody id="repTurniBody"></tbody>
</table>
</div>

<!-- DETTAGLIO RIFORNIMENTI -->
<div class="report-section">
<h3 style="font-size:16px; margin-bottom:10px;" data-translate="detail_refuels">DETTAGLIO RIFORNIMENTI</h3>
<table class="report-table">
<thead>
<tr>
<th data-translate="col_date">DATA</th>
<th data-translate="col_type">TIPO</th>
<th data-translate="col_cost">SPESA</th>
<th data-translate="col_price">PREZZO</th>
<th data-translate="col_qty">QTA</th>
</tr>
</thead>
<tbody id="repBenzaBody"></tbody>
</table>
</div>

<!-- ANALISI EFFICIENZA OPERATIVA -->
<div class="report-section">
<h3 style="font-size:16px; margin-bottom:10px;" data-translate="efficiency_analysis">ANALISI EFFICIENZA OPERATIVA</h3>
<table class="report-table">
<thead>
<tr>
<th data-translate="col_period">PERIODO</th>
<th data-translate="col_shifts">TURNI</th>
<th id="thDistanza">KM</th>
<th data-translate="col_avg">MEDIA</th>
<th data-translate="fuel_cost">BENZINA</th>
<th data-translate="col_net">NETTO</th>
<th id="thEuroOra">‚Ç¨/H</th>
</tr>
</thead>
<tbody id="repEfficienzaBody"></tbody>
</table>
</div>

<!-- MONITORAGGIO EXTRA -->
<div class="summary-box">

<h3 style="text-align:center;" data-translate="extra_monitor">MONITORAGGIO EXTRA LAVORO</h3>
<hr>

<div class="summary-row">
<span id="labelExtraKm" data-translate="extra_km">KM EXTRA:</span>
<span id="repKmExtra">0</span>
</div>

<div class="summary-row">
<span data-translate="fuel_expense">SPESA KM EXTRA:</span>
<span id="repSpesaExtra">0.00</span>
</div>

<hr>

<h3 style="text-align:center;" data-translate="general_summary">RIEPILOGO GENERALE TURNI</h3>

<div class="summary-row">
<span data-translate="hours_tot">ORE TOTALI:</span>
<span id="repOreTot">0</span>
</div>

<div class="summary-row">
<span id="labelKmTurni" data-translate="col_km_turns">KM TURNI:</span>
<span id="repKmTurni">0</span>
</div>

<div class="summary-row">
<span><strong id="labelTotKm" data-translate="total_km">TOTALE KM:</strong></span>
<span id="repKmTot">0</span>
</div>

<div class="summary-row">
<span data-translate="fuel_expense">SPESA CARBURANTE:</span>
<span id="repSpesaB">0.00</span>
</div>

<div class="summary-row">
<span id="labelAvgCostKm" data-translate="avg_cost_km">COSTO MEDIO/KM:</span>
<span id="repCostoKm">0.000</span>
</div>

<hr>

<div class="summary-row">
<span data-translate="total_gross">LORDO TOTALE:</span>
<span id="repLordo">0.00</span>
</div>

<div class="summary-row">
<span><span data-translate="taxation">TASSE</span> (<span id="repTaxPerc">0</span>%):</span>
<span id="repTasse">0.00</span>
</div>

<div class="summary-row">
<span data-translate="fuel_cost">CARBURANTE:</span>
<span id="repCarburante">0.00</span>
</div>

<hr>

<div class="summary-row total">
<span data-translate="net_total">NETTO FINALE:</span>
<span id="repNetto">0.00</span>
</div>

</div>

</div>
</div>

<div class="report-fixed-footer no-print">
<div class="backup-grid">
<button class="btn-rep-uniform" style="background: var(--primary); color: #000; border-color: var(--primary);" onclick="salvaBackup()" data-translate="export_backup">ESPORTA BACKUP</button>
<button class="btn-rep-uniform" style="background: var(--primary); color: #000; border-color: var(--primary);" onclick="document.getElementById('fileBackup').click()" data-translate="import_backup">IMPORTA BACKUP</button>
<input type="file" id="fileBackup" accept=".json" hidden>
</div>

<div class="action-grid">
<button class="btn-rep-uniform btn-black" onclick="stampaPagina()">
<i class="fas fa-print"></i> <span data-translate="print">STAMPA</span>
</button>
<button class="btn-rep-uniform" style="background: var(--accent); color:white;" onclick="apriResaView()">
<i class="fas fa-chart-line"></i> <span data-translate="yield_analysis">GRAFICO RESA</span>
</button>
<button class="btn-rep-uniform btn-grey-dark" style="grid-column: span 2;" onclick="document.getElementById('reportView').style.display='none'">
<i class="fas fa-times"></i> <span data-translate="close">CHIUDI</span>
</button>
</div>
</div>
</div>

<div id="resaView" style="display:none; position:fixed; inset:0; z-index:9500; background:#fff; color:#000;">
    <div style="padding:15px; height:100%; display:flex; flex-direction:column; gap:10px;">
        <h2 style="text-align:center; margin:5px 0 5px; font-size:16px; letter-spacing:1px;" data-translate="yield_analysis">ANALISI RESA</h2>
        <div style="flex:1; min-height:0; border:1px solid #eee; border-radius:10px; padding:5px;">
            <canvas id="chartOra"></canvas>
        </div>
        <div style="flex:1; min-height:0; border:1px solid #eee; border-radius:10px; padding:5px;">
            <canvas id="chartKm"></canvas>
        </div>
        <button class="btn-rep-uniform btn-grey-dark" style="margin-top:5px; margin-bottom: 40px;" onclick="chiudiResaView()">
            <i class="fas fa-times"></i> <span data-translate="close">Chiudi</span>
        </button>
    </div>
</div>

<div id="stickyFooterGrid" class="sticky-footer no-print">
    <div class="foot-btn" style="color:var(--primary)" onclick="apriM('modalTurno')">
        <i class="fas fa-plus-circle" style="color:var(--primary)"></i><span data-translate="btn_shift">TURNO</span>
    </div>
    <div class="foot-btn" style="color:var(--orange)" onclick="apriM('modalBenza')">
        <i class="fas fa-gas-pump" style="color:var(--orange)"></i><span data-translate="btn_fuel">FUEL</span>
    </div>
    <div class="foot-btn" style="color:var(--accent)" onclick="apriM('modalExtra')">
        <i class="fas fa-road" style="color:var(--accent)"></i><span data-translate="btn_extra">EXTRA</span>
    </div>
    <div id="btnFisco" class="foot-btn" style="color:#00CCBC; display:none;" onclick="apriFisco()">
        <i class="fas fa-piggy-bank" style="color:#00CCBC"></i><span>FISCO</span>
    </div>
    <div class="foot-btn" style="color:#ffffff" onclick="apriStorico()">
        <i class="fas fa-history" style="color:#ffffff"></i><span data-translate="btn_history">STORICO</span>
    </div>
    <button id="btnFullRep" class="btn-full" onclick="apriReport()" style="display: flex; justify-content: space-around; align-items: center; height: 50px; padding: 0 5px;">
        <span style="flex: 1;" data-translate="btn_summary">RIEPILOGO</span>
        <span style="border-left: 1px solid rgba(0,0,0,0.2); height: 100%;"></span>
        <span style="flex: 1;" data-translate="chart">GRAFICO</span>
        <span style="border-left: 1px solid rgba(0,0,0,0.2); height: 100%;"></span>
        <span style="flex: 1;" data-translate="print">STAMPA</span>
    </button>
    <div id="resetSafe" class="safe-box" onclick="safeClick()">
      <div class="safe-door">
        <div class="safe-glass"></div>
      </div>
      <div class="safe-lock">
        <i class="fas fa-lock" id="safeLockIcon"></i>
      </div>
      <div class="safe-label">RESET DB</div>
    </div>
        </div>
    </div>
    <script>
if (
  !window.matchMedia('(display-mode: standalone)').matches &&
  !window.navigator.standalone
) {
  window.location.replace('./index.html');
}
const translations = {
    it: { 
    extra_distance: "Distanza Extra",
ph_extra_distance: "Distanza extra",
ph_avg_consumption: "Consumo medio",
ph_description_optional: "Descrizione (opzionale)",
        access_msg: 'Per accedere all\'applicazione √® necessario richiedere la password nella pagina Facebook:',
        access_btn: 'ACCEDI',
        password_error: 'Password non corretta',
        gross_earned: 'LORDO GUADAGNATO',
        net_earned: 'NETTO GUADAGNATO',
        hours_tot: 'ORE TOT LAVORO',
        consumption: 'Q.T√Ä CONSUMO',
        avg_consumption: 'MEDIA CONSUMI',
        fuel_cost: 'SPESA CARBURANTE',
        net_target: 'OBIETTIVO NETTO',
        taxation: 'TASSAZIONE %',
        gross_missing: 'LORDO MANCANTE',
        objective: 'OBIETTIVO',
        average: 'MEDIA:',
        select_fuel: 'SELEZIONA CARBURANTE',
        fuel_gas: 'Benzina',
        fuel_diesel: 'Gasolio',
        fuel_cng: 'Metano',
        fuel_mix: 'Miscela',
        cancel: 'ANNULLA',
        new_shift: 'Nuovo Turno',
        select_vehicle: 'SELEZIONA MEZZO',
        vehicle_car: 'Auto',
vehicle_motorcycle: 'Moto',
vehicle_bike: 'Bici',
vehicle_escooter: 'Bici elettrica',
vehicle_scooter: 'Monopattino',
        refuel: 'Rifornimento',
        extra_km: 'KM Extra',
        extra_mi: 'MI Extra',
        col_km_turns_mi: 'MI TURNI:',
        total_mi: 'TOTALE MI:',
        avg_cost_mi: 'COSTO MEDIO/MI:',
        save: 'SALVA',
        mix_data: 'DATI MISCELA:',
        initial_price: 'PREZZO INIZIALE',
        initial_price_msg: 'Non ho trovato un prezzo precedente. Inserisci il prezzo attuale:',
        save_continue: 'SALVA E CONTINUA',
        confirm_reset: 'Conferma Reset',
        reset_msg: 'Vuoi azzerare tutto il database?',
        end_month: 'üîî FINE MESE',
        end_month_msg: 'Il mese √® terminato. Vuoi stampare il Report PDF delle tue attivit√†?',
        close: 'CHIUDI',
        print_now: 'STAMPA ORA',
        confirm_delete: 'Conferma Eliminazione',
        delete_msg: 'Sei sicuro di voler eliminare?',
        delete: 'ELIMINA',
        backup_title: 'üì¶ BACKUP DISPONIBILE',
        backup_msg: 'I tuoi dati sono stati modificati. Vuoi scaricare un backup di sicurezza?',
        not_now: 'NON ORA',
        download: 'SCARICA',
        btn_shift: 'TURNO',
        btn_fuel: 'FUEL',
        btn_history: 'STORICO',
        btn_summary: 'RIEPILOGO',
        chart: 'GRAFICO',
        print: 'STAMPA',
        history: 'STORICO',
        report_title: 'REPORT MENSILE',
        shifts: 'Turni',
        refuels: 'Rifornimenti',
        efficiency: 'Efficienza',
        summary: 'RIEPILOGO',
        col_date: 'Data',
        col_gross: 'Lordo',
        col_net: 'Netto',
        col_hours: 'Ore',
        col_type: 'Tipo',
        col_cost: 'Costo',
        col_price: 'Prezzo',
        col_qty: 'Q.t√†',
        col_period: 'Periodo',
        col_shifts: 'Turni',
        col_avg: 'Media',
        col_type_abbr: 'T',
        col_qty_abbr: 'Q',
        total_gross: 'Lordo totale:',
        fuel_expense: 'Spesa carburante:',
        taxation_applied: 'Tassazione applicata:',
        net_total: 'NETTO TOTALE:',
        yield_analysis: 'ANALISI RESA',
        detail: 'CLICCA',
        multi: 'MULTI',
        oil_label: 'olio',
        month_current: 'MESE CORRENTE',
        archive_root: 'ARCHIVIO',
        year: 'ANNO',
        delete_month: 'ELIMINA MESE',
        delete_year: 'ELIMINA ANNO',
        delete_month_msg: 'Vuoi eliminare tutti i dati del mese {month}?',
        no_data: 'Nessun dato disponibile per il periodo selezionato',
        alert_future: 'Non puoi inserire una data futura',
        alert_no_refuel: 'Nessun rifornimento trovato per questo carburante',
        alert_missing: 'Compila tutti i campi obbligatori',
        alert_mix: 'Inserisci % miscela e prezzo olio',
        hour_short: 'H',
        insert_last_price: 'Inserisci il prezzo dell\'ultimo rifornimento',
        insert_ph: 'Inserisci',
        ph_desc: 'Descrizione (opzionale)',
        ph_hours: 'Ore lavorate',
        ph_km: 'KM percorsi',
        ph_miles_driven: 'Miglia percorse',
        ph_spent: 'Speso',
        ph_gross_earned: 'Lordo guadagnato',
        ph_cons_l: 'Consumo (L/100km)',
        ph_cons_kg: 'Consumo (kg/100km)',
        detail_shifts: 'DETTAGLIO TURNI',
        detail_refuels: 'DETTAGLIO RIFORNIMENTI',
        efficiency_analysis: 'ANALISI EFFICIENZA OPERATIVA',
        extra_monitor: 'MONITORAGGIO EXTRA LAVORO',
        general_summary: 'RIEPILOGO GENERALE TURNI',
        col_km_turns: 'KM TURNI:',
        total_km: 'TOTALE KM:',
        avg_cost_km: 'COSTO MEDIO/KM:',
        export_backup: 'ESPORTA BACKUP',
        import_backup: 'IMPORTA BACKUP',
        backup_error: 'Errore nel file di backup',
        ph_mix_pct: '% Miscela',
        ph_oil_price: 'Prezzo olio (‚Ç¨/kg)',
        btn_extra: 'EXTRA',
    },
    en: { 
    extra_distance: "Extra Distance",
ph_extra_distance: "Extra distance",
ph_avg_consumption: "Average consumption",
ph_description_optional: "Description (optional)",
        access_msg: 'To access the application you need to request the password on the Facebook page:',
        access_btn: 'ACCESS',
        password_error: 'Incorrect password',
        gross_earned: 'GROSS EARNED',
        net_earned: 'NET EARNED',
        hours_tot: 'HOURS WORKED',
        consumption: 'FUEL QTY',
        avg_consumption: 'AVG CONSUMPTION',
        fuel_cost: 'FUEL COST',
        net_target: 'NET TARGET',
        taxation: 'TAXATION %',
        gross_missing: 'GROSS SHORTFALL',
        objective: 'TARGET',
        average: 'AVERAGE:',
        select_fuel: 'SELECT FUEL',
        fuel_gas: 'Gasoline',
        fuel_diesel: 'Diesel',
        fuel_cng: 'CNG',
        fuel_mix: 'Mix',
        cancel: 'CANCEL',
        new_shift: 'New Shift',
        select_vehicle: 'SELECT VEHICLE',
        vehicle_car: 'Car',
vehicle_motorcycle: 'Motorcycle',
vehicle_bike: 'Bike',
vehicle_escooter: 'E-Bike',
vehicle_scooter: 'E-Scooter',
        refuel: 'Refuel',
        extra_km: 'Extra KM',
        extra_mi: 'Extra MI',
        col_km_turns_mi: 'SHIFT MI:',
        total_mi: 'TOTAL MI:',
        avg_cost_mi: 'AVG COST/MI:',
        save: 'SAVE',
        mix_data: 'MIX DATA:',
        initial_price: 'INITIAL PRICE',
        initial_price_msg: 'No previous price found. Enter the current price:',
        save_continue: 'SAVE & CONTINUE',
        confirm_reset: 'Confirm Reset',
        reset_msg: 'Do you want to reset the entire database?',
        end_month: 'üîî END OF MONTH',
        end_month_msg: 'The month has ended. Do you want to print the PDF report of your activities?',
        close: 'CLOSE',
        print_now: 'PRINT NOW',
        confirm_delete: 'Confirm Deletion',
        delete_msg: 'Are you sure you want to delete?',
        delete: 'DELETE',
        backup_title: 'üì¶ BACKUP AVAILABLE',
        backup_msg: 'Your data has been modified. Do you want to download a backup?',
        not_now: 'NOT NOW',
        download: 'DOWNLOAD',
        btn_shift: 'SHIFT',
        btn_fuel: 'FUEL',
        btn_history: 'HISTORY',
        btn_summary: 'SUMMARY',
        chart: 'CHART',
        print: 'PRINT',
        history: 'HISTORY',
        report_title: 'MONTHLY REPORT',
        shifts: 'Shifts',
        refuels: 'Refuels',
        efficiency: 'Efficiency',
        summary: 'SUMMARY',
        col_date: 'Date',
        col_gross: 'Gross',
        col_net: 'Net',
        col_hours: 'Hours',
        col_type: 'Type',
        col_cost: 'Cost',
        col_price: 'Price',
        col_qty: 'Qty',
        col_period: 'Period',
        col_shifts: 'Shifts',
        col_avg: 'Avg',
        col_type_abbr: 'T',
        col_qty_abbr: 'Q',
        total_gross: 'Total gross:',
        fuel_expense: 'Fuel expense:',
        taxation_applied: 'Taxation applied:',
        net_total: 'NET TOTAL:',
        yield_analysis: 'ANALYTICS',
        detail: 'CLICK',
        multi: 'MULTI',
        oil_label: 'oil',
        month_current: 'CURRENT MONTH',
        archive_root: 'ARCHIVE',
        year: 'YEAR',
        delete_month: 'DELETE MONTH',
        delete_year: 'DELETE YEAR',
        delete_month_msg: 'Do you want to delete all data for {month}?',
        no_data: 'No data available for the selected period',
        chart_eur_h: '/H',
chart_eur_km: '/KM',
        alert_future: 'You cannot enter a future date',
        alert_no_refuel: 'No refuel found for this fuel type',
        alert_missing: 'Fill in all required fields',
        alert_mix: 'Enter mix % and oil price',
        insert_last_price: 'Enter the price of the last refuel',
        insert_ph: 'Enter',
        ph_desc: 'Description (optional)',
        ph_hours: 'Hours',
        ph_spent: 'Spent',
        ph_cons_l: 'Consumption (L/100km)',
        ph_cons_kg: 'Consumption (kg/100km)',
        ph_gross_earned: 'Gross earned',
        ph_km: 'KM driven',
        ph_miles_driven: 'Miles driven',
        detail_shifts: 'DETAIL SHIFTS',
        detail_refuels: 'DETAIL REFUELS',
        efficiency_analysis: 'OPERATIONAL EFFICIENCY ANALYSIS',
        extra_monitor: 'EXTRA WORK MONITORING',
        general_summary: 'GENERAL SHIFTS SUMMARY',
        col_km_turns: 'SHIFT KM:',
        total_km: 'TOTAL KM:',
        avg_cost_km: 'AVG COST/KM:',
        export_backup: 'EXPORT BACKUP',
        import_backup: 'IMPORT BACKUP',
        backup_error: 'Backup file error',
        ph_mix_pct: '% Mix',
        ph_oil_price: 'Oil price (‚Ç¨/kg)',
        btn_extra: 'EXTRA',
        hour_short: 'H'
    }
};
let currentLang = localStorage.getItem('app_language') || 'it';
function cambiaLingua(lang) {
    currentLang = lang;
    document.getElementById('htmlRoot').setAttribute('lang', lang);
    localStorage.setItem('app_language', lang);

    const flagIT = document.getElementById('flagIT');
    const flagEN = document.getElementById('flagEN');
    if (flagIT && flagEN) {
        flagIT.style.opacity = lang === 'it' ? '1' : '0.4';
        flagEN.style.opacity = lang === 'en' ? '1' : '0.4';
    }

    const savedSettings = localStorage.getItem('user_settings_' + lang);
    if (savedSettings) {
        try {
            const parsed = JSON.parse(savedSettings);
            userSettings.distance    = parsed.distance    || userSettings.distance;
            userSettings.volume      = parsed.volume      || userSettings.volume;
            userSettings.mass        = parsed.mass        || userSettings.mass;
            userSettings.currency    = parsed.currency    || userSettings.currency;
            userSettings.consumption = parsed.consumption || userSettings.consumption;
        } catch(e) {}
    }

    const mezzoLang = localStorage.getItem('ultimo_mezzo_' + lang) || 'auto';
    const selMezzo = document.getElementById('tMezzo');
    const lblMezzo = document.getElementById('labelMezzo');
    if (selMezzo) selMezzo.value = mezzoLang;
    if (lblMezzo) lblMezzo.innerText = _getMezzoLabel(mezzoLang);

    const carbTurnoLang = localStorage.getItem('ultimo_carburante_turno_' + lang) || 'benzina';
    const selCarbTurno = document.getElementById('tCarburante');
    const lblCarbTurno = document.getElementById('labelCarburanteTurno');
    if (selCarbTurno) selCarbTurno.value = carbTurnoLang;
    if (lblCarbTurno) lblCarbTurno.innerText = getIconaCarburante(carbTurnoLang) + ' ' + getNomeCarburante(carbTurnoLang);

    updateInterface();
    aggiornaLabelSettings();
    aggiornaLabelKmReport();
    calcola();
}

function aggiornaLabelKmReport() {
    const isMiles = userSettings.distance === 'miles';
    const lExt  = document.getElementById('labelExtraKm');
    const lTurni = document.getElementById('labelKmTurni');
    const lTot  = document.getElementById('labelTotKm');
    const lAvg  = document.getElementById('labelAvgCostKm');
    if (lExt)   lExt.innerText   = isMiles ? t('extra_mi')         : t('extra_km');
    if (lTurni) lTurni.innerText = isMiles ? t('col_km_turns_mi')  : t('col_km_turns');
    if (lTot)   lTot.innerText   = isMiles ? t('total_mi')         : t('total_km');
    if (lAvg)   lAvg.innerText   = isMiles ? t('avg_cost_mi')      : t('avg_cost_km');
}

function apriLanguageIT() {
    cambiaLingua('it');
    document.getElementById('modalSettings').style.display = 'none';
}

function apriLanguageEN() {
    cambiaLingua('en');
}

function apriModalSettings() {
    const settingsDist = document.getElementById('settingsDistance');
    const settingsVol  = document.getElementById('settingsVolume');
    const settingsMass = document.getElementById('settingsMass');
    const settingsCurr = document.getElementById('settingsCurrency');
    const settingsCons = document.getElementById('settingsConsumption');

    if (settingsDist) settingsDist.value = userSettings.distance;
    if (settingsVol)  settingsVol.value  = userSettings.volume;
    if (settingsMass) settingsMass.value = userSettings.mass;
    if (settingsCurr) settingsCurr.value = userSettings.currency;
    if (settingsCons) settingsCons.value = userSettings.consumption;

    document.getElementById('modalSettings').style.display = 'flex';
}
function t(chiave) {
    return translations[currentLang][chiave] || chiave;
}
function updateInterface() {
    document.querySelectorAll('[data-translate]').forEach(el => {
        const chiave = el.getAttribute('data-translate');
        el.innerText = t(chiave);
    });

    document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
        const chiave = el.getAttribute('data-translate-placeholder');
        el.placeholder = t(chiave);
    });

    const bPInput = document.getElementById('bP');
if (bPInput) {
    const bTipoVal = (document.getElementById('bTipo') || {}).value || 'benzina';
    if (bTipoVal === 'metano') {
        bPInput.placeholder = currencySymbol() + '/kg';
    } else if (userSettings.volume === 'gallons_us' || userSettings.volume === 'gallons_uk') {
        bPInput.placeholder = currencySymbol() + '/gal';
    } else {
        bPInput.placeholder = currencySymbol() + '/L';
    }
}

    const thDistanzaTurni = document.getElementById('thDistanzaTurni');
    if (thDistanzaTurni) {
        thDistanzaTurni.innerText = userSettings.distance === 'miles' ? 'MI' : 'KM';
    }

    const thConsumoTurni = document.getElementById('thConsumoTurni');
    if (thConsumoTurni) {
        thConsumoTurni.innerText = userSettings.distance === 'miles'
            ? 'C/100MI'
            : 'C/100KM';
    }

    /* --- PLACEHOLDER DINAMICI TURNO --- */

    const inputKm = document.getElementById('tK');
    if (inputKm) {
        inputKm.placeholder = userSettings.distance === 'miles'
            ? t('ph_miles_driven')
            : t('ph_km');
    }

    const inputCons = document.getElementById('tC');
    if (inputCons) {

        if (userSettings.consumption === 'km_l') {
            inputCons.placeholder = userSettings.distance === 'miles'
                ? 'MI/GAL'
                : 'KM/L';
        }

        else if (userSettings.consumption === 'mpg_us') {
            inputCons.placeholder = 'MPG (US)';
        }

        else if (userSettings.consumption === 'mpg_uk') {
            inputCons.placeholder = 'MPG (UK)';
        }

        else {
            const volUnit = (userSettings.volume === 'gallons_us' || userSettings.volume === 'gallons_uk') ? 'gal' : 'L';
            const distUnit = userSettings.distance === 'miles' ? 'mi' : '100km';
            inputCons.placeholder = volUnit + '/' + distUnit;
        }
    }

    /* --- PLACEHOLDER EXTRA KM E MEDIA DINAMICI --- */
    const _extraKmEl = document.getElementById('extraKmInput');
    if (_extraKmEl) {
        _extraKmEl.placeholder = userSettings.distance === 'miles'
            ? (currentLang === 'it' ? 'Distanza extra (mi)' : 'Extra distance (mi)')
            : (currentLang === 'it' ? 'Distanza extra (km)' : 'Extra distance (km)');
    }
    const _extraMediaEl = document.getElementById('extraMediaInput');
    if (_extraMediaEl) {
        if (userSettings.consumption === 'km_l') {
            _extraMediaEl.placeholder = userSettings.distance === 'miles' ? 'MI/GAL' : 'KM/L';
        } else if (userSettings.consumption === 'mpg_us') {
            _extraMediaEl.placeholder = 'MPG (US)';
        } else if (userSettings.consumption === 'mpg_uk') {
            _extraMediaEl.placeholder = 'MPG (UK)';
        } else {
            const _ev = (userSettings.volume === 'gallons_us' || userSettings.volume === 'gallons_uk') ? 'gal' : 'L';
            const _ed = userSettings.distance === 'miles' ? 'mi' : '100km';
            _extraMediaEl.placeholder = _ev + '/' + _ed;
        }
    }

    /* --- PLACEHOLDER OLIO DINAMICO --- */
    const _oilFields = ['bPrezzoOlio', 'pOlioInizio'];
    _oilFields.forEach(fid => {
        const el = document.getElementById(fid);
        if (el) {
            const massUnit = userSettings.mass === 'lbs' ? 'lb' : 'kg';
            const label = currentLang === 'it' ? 'Prezzo olio' : 'Oil price';
            el.placeholder = `${label} (${currencySymbol()}/${massUnit})`;
        }
    });

    /* --- REFRESH LABELS MEZZO E CARBURANTE AL CAMBIO LINGUA --- */
    const mezzoVal = document.getElementById('tMezzo');
    const lblMezzo = document.getElementById('labelMezzo');
    if (mezzoVal && lblMezzo) {
        const emojis = { auto: 'üöó', moto: 'üèçÔ∏è', bici: 'üö≤', escooter: '‚ö°', scooter: 'üõ¥' };
        const keyMap = { auto: 'vehicle_car', moto: 'vehicle_motorcycle', bici: 'vehicle_bike', escooter: 'vehicle_escooter', scooter: 'vehicle_scooter' };
        const v = mezzoVal.value || 'auto';
        lblMezzo.innerText = (emojis[v] || 'üöó') + ' ' + t(keyMap[v] || 'vehicle_car');
    }

    const carbTurnoVal = document.getElementById('tCarburante');
    const lblCarbTurno = document.getElementById('labelCarburanteTurno');
    if (carbTurnoVal && lblCarbTurno) {
        lblCarbTurno.innerText = getIconaCarburante(carbTurnoVal.value) + ' ' + getNomeCarburante(carbTurnoVal.value);
    }

    const carbBenzaVal = document.getElementById('bTipo');
    const lblCarbBenza = document.getElementById('labelCarburante');
    if (carbBenzaVal && lblCarbBenza) {
        lblCarbBenza.innerText = getIconaCarburante(carbBenzaVal.value) + ' ' + getNomeCarburante(carbBenzaVal.value);
    }

    const carbExtraVal = document.getElementById('extraCarburanteInput');
    const lblCarbExtra = document.getElementById('labelCarburanteExtra');
    if (carbExtraVal && lblCarbExtra) {
        lblCarbExtra.innerText = getIconaCarburante(carbExtraVal.value) + ' ' + getNomeCarburante(carbExtraVal.value);
    }

    // FISCO button: visibile solo in italiano
    const btnFisco = document.getElementById('btnFisco');
    const sfGrid = document.getElementById('stickyFooterGrid');
    const btnFullRep = document.getElementById('btnFullRep');
    const resetSafeEl = document.getElementById('resetSafe');
    if (btnFisco && sfGrid && btnFullRep && resetSafeEl) {
        if (currentLang === 'it') {
            btnFisco.style.display = '';
            sfGrid.style.gridTemplateColumns = 'repeat(5, 1fr)';
            btnFullRep.style.gridColumn = 'span 5';
            resetSafeEl.style.gridColumn = 'span 5';
        } else {
            btnFisco.style.display = 'none';
            sfGrid.style.gridTemplateColumns = 'repeat(4, 1fr)';
            btnFullRep.style.gridColumn = 'span 4';
            resetSafeEl.style.gridColumn = 'span 4';
        }
    }
}
    function toggleCurrency(){
    if(userSettings.currency === 'EUR') userSettings.currency = 'USD';
    else if(userSettings.currency === 'USD') userSettings.currency = 'GBP';
    else userSettings.currency = 'EUR';

    salvaUserSettings();
}

function toggleDistance(){
    userSettings.distance = userSettings.distance === 'km' ? 'miles' : 'km';
    salvaUserSettings();
}

function toggleVolume(){
    if(userSettings.volume === 'liters') userSettings.volume = 'gallons_us';
    else if(userSettings.volume === 'gallons_us') userSettings.volume = 'gallons_uk';
    else userSettings.volume = 'liters';

    salvaUserSettings();
}

function salvaUserSettings(){
    localStorage.setItem('user_settings_' + currentLang, JSON.stringify(userSettings));
    localStorage.setItem('user_settings', JSON.stringify(userSettings));

    const conferma = document.createElement('div');
    conferma.innerText = currentLang === 'it' ? 'Impostazioni salvate' : 'Settings saved';
    conferma.style.position = 'fixed';
    conferma.style.bottom = '100px';
    conferma.style.left = '50%';
    conferma.style.transform = 'translateX(-50%)';
    conferma.style.background = '#00CCBC';
    conferma.style.color = '#000';
    conferma.style.padding = '10px 15px';
    conferma.style.borderRadius = '10px';
    conferma.style.fontWeight = 'bold';
    conferma.style.zIndex = '99999';
    conferma.style.boxShadow = '0 4px 10px rgba(0,0,0,0.4)';

    document.body.appendChild(conferma);

    setTimeout(() => {
        conferma.remove();
    }, 1500);

    updateInterface();
    aggiornaLabelKmReport();
    calcola();
}
function aggiornaDBConTipoCarburante() {
    let aggiornato = false;
    
    db.turni.forEach(t => {
        if (!t.tipoCarburante) {
            t.tipoCarburante = 'benzina';
            aggiornato = true;
        }
    });
    
    db.rifornimenti.forEach(r => {
        if (!r.tipo) {
            r.tipo = 'benzina';
            aggiornato = true;
        }
    });
    
    if (aggiornato) {
        localStorage.setItem('rider_db_final_v34', JSON.stringify(db));
    }
}

let db = JSON.parse(localStorage.getItem('rider_db_final_v34')) || { 
    turni: [], 
    rifornimenti: [], 
    extraKm: [], 
    targets: {}, 
    tax: null 
};
let userSettings = JSON.parse(localStorage.getItem('user_settings')) || {
    distance: 'km',
    volume: 'liters',
    mass: 'kg',
    currency: 'EUR',
    consumption: 'l_100km'
};

function aggiornaLabelSettings(){
    const lc = document.getElementById('labelCurrency');
    const ld = document.getElementById('labelDistance');
    const lv = document.getElementById('labelVolume');

    if(lc) lc.innerText = userSettings.currency;
    if(ld) ld.innerText = userSettings.distance === 'miles' ? 'MI' : 'KM';

    if(lv){
        if(userSettings.volume === 'liters') lv.innerText = 'L';
        else if(userSettings.volume === 'gallons_us') lv.innerText = 'GAL (US)';
        else lv.innerText = 'GAL (UK)';
    }
}


function setDistance(val){
    userSettings.distance = val;
    salvaUserSettings();
}

function setVolume(val){
    userSettings.volume = val;
    salvaUserSettings();
}

function setCurrency(val){
    userSettings.currency = val;
    salvaUserSettings();
}

const KM_PER_MILE = 1.609344;
const L_PER_GALLON_US = 3.785411784;
const L_PER_GALLON_UK = 4.54609;
const LB_PER_KG = 2.20462262185;

function getExchangeRate(){
    if(userSettings.currency === 'USD') return 1.08;
    if(userSettings.currency === 'GBP') return 0.85;
    return 1;
}

function toKm(val){
    return userSettings.distance === 'miles'
        ? val * KM_PER_MILE
        : val;
}

function fromKm(val){
    return userSettings.distance === 'miles'
        ? val / KM_PER_MILE
        : val;
}

function toLiters(val){
    if(userSettings.volume === 'gallons_us')
        return val * L_PER_GALLON_US;

    if(userSettings.volume === 'gallons_uk')
        return val * L_PER_GALLON_UK;

    return val;
}

function fromLiters(val){
    if(userSettings.volume === 'gallons_us')
        return val / L_PER_GALLON_US;

    if(userSettings.volume === 'gallons_uk')
        return val / L_PER_GALLON_UK;

    return val;
}

function toKg(val){
    return userSettings.mass === 'lbs'
        ? val / LB_PER_KG
        : val;
}

function fromKg(val){
    return userSettings.mass === 'lbs'
        ? val * LB_PER_KG
        : val;
}

function toEuro(val){
    if(userSettings.currency === 'USD') return val / getExchangeRate();
    if(userSettings.currency === 'GBP') return val / getExchangeRate();
    return val;
}

function fromEuro(val){
    if(userSettings.currency === 'USD') return val * getExchangeRate();
    if(userSettings.currency === 'GBP') return val * getExchangeRate();
    return val;
}
// =============================
// ROUNDING CENTRALIZZATO UNICO
// =============================

function safeNumber(val){
    if (!isFinite(val) || isNaN(val)) return 0;
    return Number(val);
}

function roundCurrency(val){
    return safeNumber(val).toFixed(2);
}

function roundConsumption(val){
    return safeNumber(val).toFixed(1);
}

function currencySymbol(){
    if(userSettings.currency === 'USD') return '$';
    if(userSettings.currency === 'GBP') return '¬£';
    return '‚Ç¨';
}

function formatConsumption(km, litri){
    if(km === 0 || litri === 0) return "0";

    if(userSettings.consumption === 'l_100km') {

        const distanza = userSettings.distance === 'miles'
            ? fromKm(km)
            : km;

        const volume = userSettings.volume === 'gallons_us' || userSettings.volume === 'gallons_uk'
            ? fromLiters(litri)
            : litri;

        const unitaDist = userSettings.distance === 'miles' ? "mi" : "km";

        return roundConsumption((volume/distanza)*100) + " " + (userSettings.volume === 'gallons_us' || userSettings.volume === 'gallons_uk' ? "gal" : "L") + "/100" + unitaDist;
    }

    if(userSettings.consumption === 'km_l') {

        const distanza = userSettings.distance === 'miles'
            ? fromKm(km)
            : km;

        const volume = userSettings.volume === 'gallons_us' || userSettings.volume === 'gallons_uk'
            ? fromLiters(litri)
            : litri;

        const unitaDist = userSettings.distance === 'miles' ? "mi" : "km";

        const unitaVol = userSettings.volume === 'gallons_us'
            ? "gal"
            : userSettings.volume === 'gallons_uk'
            ? "gal"
            : "L";

        return roundConsumption(distanza/volume) + " " + unitaDist + "/" + unitaVol;
    }

    if(userSettings.consumption === 'mpg_us') {
        const miles = km / KM_PER_MILE;
        const gal = litri / L_PER_GALLON_US;
        return roundConsumption(miles/gal) + " MPG (US)";
    }

    if(userSettings.consumption === 'mpg_uk') {
        const miles = km / KM_PER_MILE;
        const gal = litri / L_PER_GALLON_UK;
        return roundConsumption(miles/gal) + " MPG (UK)";
    }

    return "0";
}
    let multiSnapshot = {
    consumo: null,
    efficienza: null
};
    const mesiIt = ["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"];
    const mesiEn = ["January","February","March","April","May","June","July","August","September","October","November","December"];

let catElimina = '', idElimina = null, tipoCarburantePrezzoIniziale = '', meseDaEliminare = null, annoDaEliminare = null, reportMeseKey = null;

let safeStep = 0;
let safeTimeout = null;

function safeClick(){
  if(safeStep === 0){
    document.querySelector('.safe-door').classList.add('open');
    const safeLock = document.querySelector('.safe-lock');
    if(safeLock) safeLock.classList.add('unlock');
    document.getElementById('safeLockIcon').classList.replace('fa-lock','fa-lock-open');
    safeStep = 1;
    safeTimeout = setTimeout(resetSafe, 1000);
  }
  else{
    clearTimeout(safeTimeout);
    resetSafe();
    document.getElementById('modalConfirm').style.display = 'flex';
  }
}

function resetSafe(){
  document.querySelector('.safe-door').classList.remove('open');
  const safeLock = document.querySelector('.safe-lock');
  if(safeLock) safeLock.classList.remove('unlock');
  document.getElementById('safeLockIcon').classList.replace('fa-lock-open','fa-lock');
  safeStep = 0;
}

function confermaReset() { 
    localStorage.removeItem('rider_db_final_v34'); 
    location.reload(); 
}

    function aggiornaTarget() {
        const adesso = new Date();
        const chiaveNetto = `${(adesso.getMonth()+1).toString().padStart(2,'0')}/${adesso.getFullYear()}`;
        db.targets[chiaveNetto] = parseFloat(document.getElementById('targetIn').value) || null;
        salvaDB();
    }

    function aggiornaTax() {
        db.tax = parseFloat(document.getElementById('taxIn').value) || null;
        salvaDB();
    }

    function salvaDB() {
        localStorage.setItem('rider_db_final_v34', JSON.stringify(db));
        calcola();
    }
    function calcola() {
    const n = new Date();
    const tag = `${(n.getMonth()+1).toString().padStart(2,'0')}/${n.getFullYear()}`;
    const turniMese = db.turni.filter(t => t.data.endsWith(tag));

    const taxPerc = (db.tax !== null && db.tax !== undefined) ? db.tax : 0;

    let lordoA = turniMese.reduce((a,b)=>a+b.lordo, 0);
    let ore = turniMese.reduce((a,b)=>a+b.ore, 0);
    let km = turniMese.reduce((a,b)=>a+b.km, 0);

    let costoB_Turni = 0;
    turniMese.forEach(t => {
        const quantita = t.km * (t.cons / 100);
        let costo = quantita * (t.prezzo || 0);

        if (t.tipoCarburante === 'miscela' && t.percMiscela && t.prezzoOlio) {
            costo += (quantita * (t.percMiscela / 100)) * t.prezzoOlio;
        }

        costoB_Turni += costo;
    });

    const rifMese = db.rifornimenti.filter(r => r.data.endsWith(tag));
    let spesaB_Reale = rifMese.reduce((a,b)=>a+b.euro, 0);

    let nettoA = lordoA - (lordoA * (taxPerc/100)) - costoB_Turni;

    document.getElementById('lordo').innerText =
    currencySymbol() + roundCurrency(safeNumber(fromEuro(lordoA)));
    document.getElementById('netto').innerText = currencySymbol() + roundCurrency(safeNumber(fromEuro(nettoA)));
    document.getElementById('ore').innerText = ore.toFixed(1);

    const consumiPerTipo = {};
    turniMese.forEach(t => {
        const tipo = t.tipoCarburante || 'benzina';
        const q = t.km * (t.cons / 100);
        if (!consumiPerTipo[tipo]) consumiPerTipo[tipo] = 0;
        consumiPerTipo[tipo] += q;
    });

    const tipiCarb = Object.keys(consumiPerTipo);

    multiSnapshot.consumo = null;
    multiSnapshot.efficienza = null;

    if (tipiCarb.length === 1) {
        const tipo = tipiCarb[0];
        const unita = getUnitaCarburante(tipo);
        const litriTot = consumiPerTipo[tipo];
        const volDisplay = tipo === 'metano' ? litriTot : fromLiters(litriTot);
        document.getElementById('cons').innerText = volDisplay.toFixed(1) + unita;
        document.getElementById('cons').classList.remove('clickable');
        document.getElementById('cons').onclick = null;

        const totQ = consumiPerTipo[tipo];
        let mediaConsumo = 0;

if (totQ > 0) {

    if (userSettings.distance === 'miles') {

        const miles = fromKm(km);

        if (userSettings.volume === 'gallons_us') {
            mediaConsumo = miles / (fromLiters(totQ));
        } else if (userSettings.volume === 'gallons_uk') {
            mediaConsumo = miles / (fromLiters(totQ));
        } else {
            mediaConsumo = miles / totQ;
        }

    } else {
        mediaConsumo = km / totQ;
    }
}

document.getElementById('kml').innerText = roundConsumption(safeNumber(mediaConsumo));
        document.getElementById('kml').classList.remove('clickable');
        document.getElementById('kml').onclick = null;
    } else if (tipiCarb.length > 1) {
        document.getElementById('cons').innerText = t('multi');
        document.getElementById('cons').classList.add('clickable');
        document.getElementById('cons').onclick = () => apriMulti('consumo');
        multiSnapshot.consumo = { consumiPerTipo: { ...consumiPerTipo } };

        document.getElementById('kml').innerText = t('multi');
        document.getElementById('kml').classList.add('clickable');
        document.getElementById('kml').onclick = () => apriMulti('efficienza');
        multiSnapshot.efficienza = { consumiPerTipo: { ...consumiPerTipo }, kmTotali: km };
    }

    document.getElementById('spesaB').innerText = currencySymbol() + roundCurrency(safeNumber(fromEuro(costoB_Turni)));

    let mediaO = ore > 0 ? (nettoA / ore) : 0;
    document.getElementById('mediaOraria').innerText =
    t('average') + ' ' +
    currencySymbol() +
    roundCurrency(fromEuro(mediaO)) +
    '/' + t('hour_short');

    let tNetto = db.targets[tag];
    document.getElementById('targetIn').value = (tNetto !== null && tNetto !== undefined && tNetto !== 0) ? tNetto : "";
    document.getElementById('taxIn').value = (db.tax !== null && db.tax !== undefined) ? db.tax : "";

    let lordoNecessario = (tNetto + costoB_Turni) / (1 - (taxPerc/100));
    let mancaL = lordoNecessario - lordoA;
    document.getElementById('mancante').innerText = currencySymbol() + (mancaL > 0 ? roundCurrency(safeNumber(fromEuro(mancaL))) : "0.00");

    let p = tNetto > 0 ? Math.min((nettoA/tNetto)*100, 100) : 0;
    document.getElementById('perc').innerText = Math.round(p) + '%';
    document.getElementById('bar').style.width = p + '%';
}

function isDataFutura(d, m, y) {
    return new Date(y, m - 1, d) > new Date().setHours(23,59,59,999);
}

function apriM(id) { 
    const n = new Date(); 
    let d='', m='', y=''; 
    const mesiArr = currentLang === 'it' ? mesiIt : mesiEn;
    
    for(let i=1; i<=31; i++) 
        d += `<option value="${i}" ${i==n.getDate()?'selected':''}>${i}</option>`; 
    
    mesiArr.forEach((nm,i) => 
        m += `<option value="${i+1}" ${i==n.getMonth()?'selected':''}>${nm.substring(0,3)}</option>`
    ); 
    
    for(let i=2024; i<=n.getFullYear(); i++) 
        y += `<option value="${i}" ${i==n.getFullYear()?'selected':''}>${i}</option>`; 
    
    let p = id==='modalTurno' ? 'dateT' : (id==='modalBenza' ? 'dateB' : 'dateE'); 
    document.getElementById(p).innerHTML = `<select id="${p}D">${d}</select><select id="${p}M">${m}</select><select id="${p}Y">${y}</select>`; 
    
    if (id === 'modalTurno') {
        const ultimoMezzo = localStorage.getItem('ultimo_mezzo_' + currentLang) || 'auto';
        document.getElementById('tMezzo').value = ultimoMezzo;
        document.getElementById('labelMezzo').innerText = _getMezzoLabel(ultimoMezzo);
        document.getElementById('tC').style.display = ultimoMezzo === 'bici' ? 'none' : 'block';
        const ultimoCarb = localStorage.getItem('ultimo_carburante_turno_' + currentLang) || 'benzina';
        document.getElementById('tCarburante').value = ultimoCarb;
        document.getElementById('labelCarburanteTurno').innerText = getIconaCarburante(ultimoCarb) + ' ' + getNomeCarburante(ultimoCarb);
        const _campoC = document.getElementById('tC');
        if (_campoC) {
            if (ultimoCarb === 'metano') {
                _campoC.placeholder = t('ph_cons_kg');
            } else if (userSettings.consumption === 'km_l') {
                _campoC.placeholder = userSettings.distance === 'miles' ? 'MI/GAL' : 'KM/L';
            } else if (userSettings.consumption === 'mpg_us') {
                _campoC.placeholder = 'MPG (US)';
            } else if (userSettings.consumption === 'mpg_uk') {
                _campoC.placeholder = 'MPG (UK)';
            } else {
                const _volUnit = (userSettings.volume === 'gallons_us' || userSettings.volume === 'gallons_uk') ? 'gal' : 'L';
                const _distUnit = userSettings.distance === 'miles' ? 'mi' : '100km';
                _campoC.placeholder = _volUnit + '/' + _distUnit;
            }
        }
        aggiornaSuggerimentoConsumo(ultimoCarb);
    }

    if (id === 'modalBenza') {
        const ultimoCarb = localStorage.getItem('ultimo_carburante_benza_' + currentLang) || 'benzina';
        document.getElementById('bTipo').value = ultimoCarb;
        document.getElementById('labelCarburante').innerText = getIconaCarburante(ultimoCarb) + ' ' + getNomeCarburante(ultimoCarb);
    }

    if (id === 'modalExtra') {
        const ultimoCarb = localStorage.getItem('ultimo_carburante_extra_' + currentLang) || 'benzina';
        document.getElementById('extraCarburanteInput').value = ultimoCarb;
        document.getElementById('labelCarburanteExtra').innerText = getIconaCarburante(ultimoCarb) + ' ' + getNomeCarburante(ultimoCarb);
    }

    document.getElementById(id).style.display='flex'; 
}
function apriStorico() {
    const tutti = [
        ...db.turni.map(t => ({...t, tipo: 'T'})),
        ...db.rifornimenti.map(r => ({...r, tipo: 'B', tipo_fuel: r.tipo || 'benzina'})),
        ...db.extraKm.map(e => ({...e, tipo: 'E'}))
    ].sort((a, b) => b.id - a.id);

    const now = new Date();
    const meseCorrenteKey = `${(now.getMonth() + 1).toString().padStart(2, '0')}/${now.getFullYear()}`;

    const taxPerc = (db.tax !== null && db.tax !== undefined) ? db.tax : 0;

    let htmlCorrente = "";
    let gruppiPassati = {};
    let ordineMesi = [];

    let nettoTotMese = 0;
    let oreTotMese = 0;

    db.turni.forEach(t => {
        if (t.data.substring(3) === meseCorrenteKey) {

            let quantita = t.km * (t.cons / 100);
            let costo = quantita * (t.prezzo || 0);

            if (t.tipoCarburante === 'miscela' && t.percMiscela && t.prezzoOlio) {
                costo += (quantita * (t.percMiscela / 100)) * t.prezzoOlio;
            }

            nettoTotMese += (t.lordo - (t.lordo * (taxPerc / 100)) - costo);
            oreTotMese += t.ore;
        }
    });

    let mediaOraMese = oreTotMese > 0 ? nettoTotMese / oreTotMese : 0;

    tutti.forEach(i => {

        let key = i.data.substring(3);
        let html = generaHtmlItem(i, mediaOraMese);

        if (key === meseCorrenteKey) {

            htmlCorrente += html;

        } else {

            if (!gruppiPassati[key]) {
                gruppiPassati[key] = { items: [], lordo: 0, netto: 0, ore: 0 };
                ordineMesi.push(key);
            }

            gruppiPassati[key].items.push(html);

            if (i.tipo === 'T') {

                let quantita = i.km * (i.cons / 100);
                let costo = quantita * (i.prezzo || 0);

                if (i.tipoCarburante === 'miscela' && i.percMiscela && i.prezzoOlio) {
                    costo += (quantita * (i.percMiscela / 100)) * i.prezzoOlio;
                }

                gruppiPassati[key].lordo += i.lordo;
                gruppiPassati[key].netto += (i.lordo - (i.lordo * (taxPerc / 100)) - costo);
                gruppiPassati[key].ore += i.ore;
            }
        }
    });

    let htmlFinale = "";

    if (htmlCorrente) {
        htmlFinale += `
        <div style="margin-bottom:20px;">
            <div style="font-size:11px; color:var(--primary); font-weight:bold; padding:5px; border-bottom:1px solid #333; margin-bottom:10px; letter-spacing:1px;">
                ${t('month_current')} (${meseCorrenteKey})
            </div>
            ${htmlCorrente}
        </div>`;
    }

    ordineMesi = [...new Set(ordineMesi)];

    let storicoPerAnni = {};
    ordineMesi.forEach(key => {
        let anno = key.split('/')[1];
        if (!storicoPerAnni[anno]) storicoPerAnni[anno] = [];
        storicoPerAnni[anno].push(key);
    });

    let anniSorted = Object.keys(storicoPerAnni).sort((a, b) => b - a);

    htmlFinale += `<div style="font-size:11px; color:var(--dim); font-weight:bold; padding:5px; border-bottom:1px solid #333; margin-bottom:10px; letter-spacing:1px; margin-top:15px;">${t('archive_root')}</div>`;

    anniSorted.forEach(anno => {
        let mesi = storicoPerAnni[anno].sort((a, b) => {
            let [mA, yA] = a.split('/');
            let [mB, yB] = b.split('/');
            return new Date(yB, mB - 1) - new Date(yA, mA - 1);
        });

        let annoLordo = 0;
        let annoNetto = 0;
        let annoOre = 0;

        mesi.forEach(key => {
            annoLordo += gruppiPassati[key].lordo;
            annoNetto += gruppiPassati[key].netto;
            annoOre += gruppiPassati[key].ore;
        });

        let annoId = `anno_${anno}`;

        htmlFinale += `
        <div class="month-group">
            <div class="month-header" onclick="toggleAnno('${annoId}')">
                <div>
                    <div class="month-title">${t('year')} ${anno}</div>
                    <div class="month-summary">
                        ${currencySymbol()}${fromEuro(annoLordo).toFixed(2)} | 
                        ${currencySymbol()}${fromEuro(annoNetto).toFixed(2)} | 
                        ${annoOre.toFixed(1)}h
                    </div>
                </div>
                <div class="month-actions">
                    <button class="btn-del-month" onclick="event.stopPropagation(); confermaEliminaAnno('${anno}');">
                        <i class="fas fa-trash"></i>
                    </button>
                    <i class="fas fa-chevron-down month-chevron" id="chev_${annoId}" style="color:#888;"></i>
                </div>
            </div>
            <div class="month-body" id="body_${annoId}">
        `;

        mesi.forEach(key => {
            let dati = gruppiPassati[key];
            let meseId = `mese_${key.replace('/', '_')}`;

            htmlFinale += `
            <div class="month-group" style="margin:5px; border-radius:10px;">
                <div class="month-header" onclick="toggleMese('${meseId}')">
                    <div>
                        <div class="month-title">${getNomeMese(key)}</div>
                        <div class="month-summary">
                            ${currencySymbol()}${fromEuro(dati.lordo).toFixed(2)} | 
                            ${currencySymbol()}${fromEuro(dati.netto).toFixed(2)} | 
                            ${dati.ore.toFixed(1)}h
                        </div>
                    </div>
                    <div class="month-actions">
                        <button class="btn-rep-month" onclick="event.stopPropagation(); apriReport('${key}');">
                            <i class="fas fa-file-pdf"></i> PDF
                        </button>
                        <button class="btn-del-month" onclick="event.stopPropagation(); confermaEliminaMese('${key}');">
                            <i class="fas fa-trash"></i>
                        </button>
                        <i class="fas fa-chevron-down month-chevron" id="chev_${meseId}" style="color:#888;"></i>
                    </div>
                </div>
                <div class="month-body" id="body_${meseId}">
                    ${dati.items.join('')}
                </div>
            </div>
            `;
        });

        htmlFinale += `
            </div>
        </div>
        `;
    });

    document.getElementById('listaStorico').innerHTML = htmlFinale;
    document.getElementById('histView').style.display = 'flex';
}

function toggleAnno(id) {
    const body = document.getElementById(`body_${id}`);
    const chevron = document.getElementById(`chev_${id}`);

    if (body.classList.contains('open')) {
        body.classList.remove('open');
        chevron.style.transform = 'rotate(0deg)';
    } else {
        body.classList.add('open');
        chevron.style.transform = 'rotate(180deg)';
    }
}

function generaHtmlItem(i, mediaOraMese) {
    let html = `<div class="storico-item"><div class="storico-info">`;

    if (i.tipo === 'T') {
        let quantita = i.km * (i.cons / 100);
        let costo = quantita * (i.prezzo || 0);
        if (i.tipoCarburante === 'miscela') {
            costo += (quantita * (i.percMiscela / 100)) * i.prezzoOlio;
        }

        let netto = i.lordo - (i.lordo * (db.tax / 100)) - costo;
        let euroOra = i.ore > 0 ? (netto / i.ore).toFixed(2) : '0.00';

        let colore = '#bbb';
        if (mediaOraMese > 0 && i.ore > 0) {
            const rapporto = (netto / i.ore) / mediaOraMese;
            if (rapporto >= 1.15) colore = '#4ade80';
            else if (rapporto <= 0.85) colore = '#ff6b6b';
        }

        const unitaC = getUnitaCarburante(i.tipoCarburante);
        const iconaC = getIconaCarburante(i.tipoCarburante);

        const kmDisplay = fromKm(i.km);
        const distUnit = userSettings.distance === 'miles' ? 'mi' : 'km';

        html += `<div class="tipo-label" style="color:var(--primary);">
            <i class="fas fa-plus-circle"></i> ${t('btn_shift')} ‚Ä¢ ${i.mezzo.toUpperCase()}
        </div>
        <div class="storico-date-row">
            <span>${i.data.substring(0, 5)}</span>
            <span class="storico-hour">${i.ora || ''}</span>
        </div>
        <div class="storico-main" style="color:${colore};">${currencySymbol()}${fromEuro(netto).toFixed(2)} ‚Ä¢ ${currencySymbol()}${fromEuro(parseFloat(euroOra)).toFixed(2)}/h</div>
        <div class="storico-sub">
            ${currencySymbol()}${fromEuro(i.lordo).toFixed(2)} / ${i.ore.toFixed(1)}h / ${kmDisplay.toFixed(1)}${distUnit} / ${formatConsumption(i.km, i.km * (i.cons / 100))} ${iconaC}
        </div>`;
} else if (i.tipo === 'B') {
        const unitaC = getUnitaCarburante(i.tipo_fuel);
        const iconaC = getIconaCarburante(i.tipo_fuel);
        const qtaBase = i.euro / i.prezzo;
        const isMetano = i.tipo_fuel === 'metano';
        const isMiscela = i.tipo_fuel === 'miscela';
        const massUnit = userSettings.mass === 'lbs' ? 'lb' : 'kg';
        const volUnit = userSettings.volume === 'gallons_us' ? 'gal' : userSettings.volume === 'gallons_uk' ? 'gal(UK)' : 'L';
        const qtaDisplay = isMetano ? fromKg(qtaBase).toFixed(2) : fromLiters(qtaBase).toFixed(2);
        const unitaDisplay = isMetano ? massUnit : volUnit;
        let miscelaExtra = '';
        if (isMiscela && i.percMiscela && i.prezzoOlio) {
            const kgOlio = qtaBase * (i.percMiscela / 100);
            miscelaExtra = ` | ${(i.percMiscela).toFixed(1)}% ‚Üí ${fromKg(kgOlio).toFixed(2)}${massUnit} ${t('oil_label')}`;
        }

        html += `<div class="tipo-label" style="color:var(--orange);">
            <i class="fas fa-gas-pump"></i> ${iconaC} ${getNomeCarburante(i.tipo_fuel).toUpperCase()}
        </div>
        <div class="storico-date-row">
            <span>${i.data.substring(0, 5)}</span>
        </div>
        <div class="storico-main">${currencySymbol()}${fromEuro(i.euro).toFixed(2)}</div>
        <div class="storico-sub">
    ${qtaDisplay} ${unitaDisplay} ‚Ä¢ ${currencySymbol()}${fromEuro(i.prezzo).toFixed(2)}/${unitaDisplay}${miscelaExtra}
</div>`;
    } else if (i.tipo === 'E') {
        const unitaC = getUnitaCarburante(i.carburante);
        const iconaC = getIconaCarburante(i.carburante);
        const kmDisplay = fromKm(i.km);
        const distUnit = userSettings.distance === 'miles' ? 'mi' : 'km';

        html += `<div class="tipo-label" style="color:var(--accent);">
            <i class="fas fa-road"></i> ${userSettings.distance === 'miles' ? t('extra_mi') : t('extra_km')} ${iconaC}
        </div>
        <div class="storico-date-row">
            <span>${i.data.substring(0, 5)}</span>
        </div>
        <div class="storico-main">${kmDisplay.toFixed(1)}${distUnit} ‚Ä¢ ${currencySymbol()}${fromEuro(i.importo).toFixed(2)}</div>
        <div class="storico-sub">${i.media.toFixed(1)}${unitaC} ‚Ä¢ ${i.desc || ''}</div>`;
    }

    html += `</div>
        <div onclick="elimina('${i.tipo === 'T' ? 'turni' : (i.tipo === 'B' ? 'rifornimenti' : 'extraKm')}', ${i.id})" style="padding:10px; cursor:pointer;">
            <i class="fas fa-trash" style="color:var(--accent); font-size:18px;"></i>
        </div>
    </div>`;

    return html;
}

function toggleMese(id) {
    const body = document.getElementById(`body_${id}`);
    const chevron = document.getElementById(`chev_${id}`);
    
    if (body.classList.contains('open')) {
        body.classList.remove('open');
        chevron.style.transform = 'rotate(0deg)';
    } else {
        body.classList.add('open');
        chevron.style.transform = 'rotate(180deg)';
    }
}

function getNomeMese(key) {
    const [m, y] = key.split('/');
    const mesiArr = currentLang === 'it' ? mesiIt : mesiEn;
    return mesiArr[parseInt(m) - 1] + ' ' + y;
}

function confermaEliminaMese(key) {
    meseDaEliminare = key;
    catElimina = 'MESE';
    const nomeMese = getNomeMese(key);
    document.querySelector('#modalElimina p').innerText = t('delete_month_msg').replace('{month}', nomeMese);
    document.getElementById('modalElimina').style.display = 'flex';
}

function eseguiEliminazioneMese() {
    if (meseDaEliminare) {
        db.turni = db.turni.filter(t => !t.data.endsWith(meseDaEliminare));
        db.rifornimenti = db.rifornimenti.filter(r => !r.data.endsWith(meseDaEliminare));
        db.extraKm = db.extraKm.filter(e => !e.data.endsWith(meseDaEliminare));
        
        salvaDB();
        apriStorico();
        chiudiModali();
    }
}
function apriMulti(tipo) {
    const snap = multiSnapshot[tipo];
    if (!snap) return;

    let html = '';
    let title = tipo === 'consumo' ? t('consumption') : t('efficiency');

    Object.keys(snap.consumiPerTipo).forEach(tipoC => {
        const unita = getUnitaCarburante(tipoC);
        const litriRaw = snap.consumiPerTipo[tipoC];
        const vol = tipoC === 'metano' ? fromKg(litriRaw) : fromLiters(litriRaw);
        const massUnit = userSettings.mass === 'lbs' ? 'lb' : 'kg';
        const unitaDisplay = tipoC === 'metano' ? massUnit : unita;
        const distUnit = userSettings.distance === 'miles' ? 'mi' : 'km';
        let val;
        if (tipo === 'consumo') {
            val = vol.toFixed(2) + unitaDisplay;
        } else {
            const distDisplay = fromKm(snap.kmTotali);
            val = litriRaw > 0 ? (distDisplay / vol).toFixed(1) + ' ' + distUnit + '/' + unitaDisplay : '0.0';
        }
        html += `<div style="margin-bottom:8px;">${getIconaCarburante(tipoC)} ${getNomeCarburante(tipoC)}: <strong>${val}</strong></div>`;
    });

    document.getElementById('multiTitle').innerText = title;
    document.getElementById('multiBody').innerHTML = html;
    document.getElementById('modalMulti').style.display = 'flex';
}
function apriReport(meseKey) {
    reportMeseKey = meseKey;
    const tag = meseKey || `${(new Date().getMonth()+1).toString().padStart(2,'0')}/${new Date().getFullYear()}`;
    
    aggiornaLabelKmReport();
    document.getElementById('reportMeseLabel').innerText = getNomeMese(tag);

    const turniMese = db.turni.filter(t => t.data.endsWith(tag)).sort((a, b) => a.id - b.id);
    const rifMese = db.rifornimenti.filter(r => r.data.endsWith(tag)).sort((a, b) => a.id - b.id);

    let htmlTurni = '';
    let lordoTot = 0;
    let spesaBTot = 0;
    let tassazioneTot = 0;
    let tK = 0;
    let tO = 0;

    turniMese.forEach(t => {
        const q = t.km * (t.cons / 100);
        let costoB = q * (t.prezzo || 0);
        if (t.tipoCarburante === 'miscela' && t.percMiscela && t.prezzoOlio) {
            costoB += (q * (t.percMiscela / 100)) * t.prezzoOlio;
        }

        const unitaC = getUnitaCarburante(t.tipoCarburante);
        const iconaC = getIconaCarburante(t.tipoCarburante);
        const nomeC = getNomeCarburante(t.tipoCarburante);

        const taxPerc = (db.tax !== null && db.tax !== undefined) ? db.tax : 0;
const netto = t.lordo - (t.lordo * (taxPerc / 100)) - costoB;

        lordoTot += t.lordo;
        spesaBTot += costoB;
        tassazioneTot += (t.lordo * (db.tax / 100));
        tK += t.km;
        tO += t.ore;

        const massUnit = userSettings.mass === 'lbs' ? 'lb' : 'kg';
        let qCellDisplay;
        if (t.tipoCarburante === 'metano') {
            qCellDisplay = `${fromKg(q).toFixed(2)}${massUnit}`;
        } else if (t.tipoCarburante === 'miscela' && t.percMiscela) {
            const kgOlio = q * (t.percMiscela / 100);
            const litBenz = q - kgOlio;
            qCellDisplay = `${fromLiters(litBenz).toFixed(2)}${unitaC}+${fromKg(kgOlio).toFixed(2)}${massUnit}`;
        } else {
            qCellDisplay = `${fromLiters(q).toFixed(2)}${unitaC}`;
        }

        htmlTurni += `<tr>
            <td>${t.data}</td>
            <td>${currencySymbol()}${fromEuro(t.lordo).toFixed(2)}</td>
            <td>${currencySymbol()}${fromEuro(netto).toFixed(2)}</td>
            <td>${t.ore.toFixed(1)}</td>
          <td>${fromKm(t.km).toFixed(2)} ${userSettings.distance === 'miles' ? 'mi' : 'km'}</td>
            <td>${t.cons.toFixed(1)}</td>
            <td class="tipo-abbrev-mi">${iconaC}</td>
            <td>${qCellDisplay}</td>
        </tr>`;
    });

    document.getElementById('repTurniBody').innerHTML = htmlTurni || '<tr><td colspan="8">‚Äî</td></tr>';

    let htmlBenza = '';
    rifMese.forEach(r => {
        const unitaC = getUnitaCarburante(r.tipo);
        const iconaC = getIconaCarburante(r.tipo);
        const nomeC = getNomeCarburante(r.tipo);
        const litri = r.euro / r.prezzo;
        const massUnit = userSettings.mass === 'lbs' ? 'lb' : 'kg';
        const volDisplay = r.tipo === 'metano' ? fromKg(litri) : fromLiters(litri);
        const unitaCDisplay = r.tipo === 'metano' ? massUnit : unitaC;

        htmlBenza += `<tr>
            <td>${r.data}</td>
            <td>${iconaC} ${nomeC}</td>
            <td>${currencySymbol()}${fromEuro(r.euro).toFixed(2)}</td>
            <td>${currencySymbol()}${fromEuro(r.prezzo).toFixed(2)}/${unitaCDisplay}</td>
           <td>${volDisplay.toFixed(2)} ${unitaCDisplay}</td>
        </tr>`;
    });
    document.getElementById('repBenzaBody').innerHTML = htmlBenza || '<tr><td colspan="5">‚Äî</td></tr>';

    const periodi = calcolaPeriodiConsumo(turniMese, db.tax);
let htmlEff = '';

periodi.forEach(p => {

    const litriPeriodo = (p.km * p.consumoMedio) / 100;

    htmlEff += `<tr>
        <td>${p.periodo}</td>
        <td>${p.count}</td>
        <td>${fromKm(p.km).toFixed(2)} ${userSettings.distance === 'miles' ? 'mi' : 'km'}</td>
        <td>${formatConsumption(p.km, litriPeriodo)}</td>
        <td>${currencySymbol()}${fromEuro(p.costoB).toFixed(2)}</td>
        <td>${currencySymbol()}${fromEuro(p.netto).toFixed(2)}</td>
        <td>${currencySymbol()}${fromEuro(p.euroOra).toFixed(2)}</td>
    </tr>`;
});

    document.getElementById('repEfficienzaBody').innerHTML = htmlEff || '<tr><td colspan="7">‚Äî</td></tr>';

    const nettoTot = lordoTot - tassazioneTot - spesaBTot;

    document.getElementById('repLordo').innerText =
    currencySymbol() + roundCurrency(safeNumber(fromEuro(lordoTot)));

document.getElementById('repSpesaB').innerText =
    currencySymbol() + roundCurrency(safeNumber(fromEuro(spesaBTot)));

const repTasse = document.getElementById('repTasse');
if (repTasse) {
    repTasse.innerText =
        '-' + currencySymbol() + roundCurrency(safeNumber(fromEuro(tassazioneTot)));
}

const repCarburante = document.getElementById('repCarburante');
if (repCarburante) {
    repCarburante.innerText =
        '-' + currencySymbol() + roundCurrency(safeNumber(fromEuro(spesaBTot)));
}

document.getElementById('repNetto').innerText =
    currencySymbol() + roundCurrency(safeNumber(fromEuro(nettoTot)));

const distUnit = userSettings.distance === 'miles' ? 'mi' : 'km';
const kmEx = (db.extraKm || []).filter(e => e.data.endsWith(tag)).reduce((a,b)=>a+b.km,0);
const spesaEx = (db.extraKm || []).filter(e => e.data.endsWith(tag)).reduce((a,b)=>a+(b.importo||0),0);

const elRepKmExtra = document.getElementById('repKmExtra');
if (elRepKmExtra) elRepKmExtra.innerText = fromKm(kmEx).toFixed(0) + ' ' + distUnit;

const elRepSpesaExtra = document.getElementById('repSpesaExtra');
if (elRepSpesaExtra) elRepSpesaExtra.innerText = currencySymbol() + fromEuro(spesaEx).toFixed(2);

const elRepOreTot = document.getElementById('repOreTot');
if (elRepOreTot) elRepOreTot.innerText = tO.toFixed(1) + 'h';

const elRepKmTurni = document.getElementById('repKmTurni');
if (elRepKmTurni) elRepKmTurni.innerText = fromKm(tK).toFixed(0) + ' ' + distUnit;

const elRepKmTot = document.getElementById('repKmTot');
if (elRepKmTot) elRepKmTot.innerText = fromKm(tK + kmEx).toFixed(0) + ' ' + distUnit;

const elRepCostoKm = document.getElementById('repCostoKm');
if (elRepCostoKm) elRepCostoKm.innerText = currencySymbol() + (tK > 0 ? fromEuro(spesaBTot / tK).toFixed(3) : '0.000');

const elRepTaxPerc = document.getElementById('repTaxPerc');
if (elRepTaxPerc) elRepTaxPerc.innerText = db.tax || 0;

const thDistanza = document.getElementById('thDistanza');
if (thDistanza) {
    thDistanza.innerText = userSettings.distance === 'miles' ? 'MI' : 'KM';
}

const thEuroOra = document.getElementById('thEuroOra');
if (thEuroOra) {
    thEuroOra.innerText = currencySymbol() + '/' + t('hour_short');
}

const thDistanzaTurni = document.getElementById('thDistanzaTurni');
if (thDistanzaTurni) {
    thDistanzaTurni.innerText = userSettings.distance === 'miles' ? 'MI' : 'KM';
}

const thConsumoTurni = document.getElementById('thConsumoTurni');
if (thConsumoTurni) {

    if (userSettings.distance === 'miles') {

        if (userSettings.volume === 'gallons_us') {
            thConsumoTurni.innerText = 'MPG (US)';
        } else if (userSettings.volume === 'gallons_uk') {
            thConsumoTurni.innerText = 'MPG (UK)';
        } else {
            thConsumoTurni.innerText = 'C/100MI';
        }

    } else {
        thConsumoTurni.innerText = 'C/100KM';
    }
}
    document.getElementById('reportView').style.display = 'flex';
}

function calcolaPeriodiConsumo(turni, tax) {
    const gruppi = {};
    turni.forEach(t => {
        const settimana = Math.ceil(parseInt(t.data.substring(0,2)) / 7);
        const chiave = `S${settimana}`;
        if (!gruppi[chiave]) gruppi[chiave] = [];
        gruppi[chiave].push(t);
    });

    return Object.keys(gruppi).sort().map(k => {
        const arr = gruppi[k];
        const primo = Math.min(...arr.map(t => parseInt(t.data.substring(0,2))));
        const ultimo = Math.max(...arr.map(t => parseInt(t.data.substring(0,2))));
        
        let totL = 0, totO = 0, totK = 0, totLitri = 0, totCostoB = 0;

        arr.forEach(t => {
            const q = t.km * (t.cons / 100);
            let c = q * (t.prezzo || 0);
            if (t.tipoCarburante === 'miscela' && t.percMiscela && t.prezzoOlio) {
                c += (q * (t.percMiscela / 100)) * t.prezzoOlio;
            }

            totL += t.lordo;
            totO += t.ore;
            totK += t.km;
            totLitri += q;
            totCostoB += c;
        });

        const netto = totL - (totL * (tax / 100)) - totCostoB;

        return {
            periodo: `${primo}->${ultimo}`,
            count: arr.length,
            lordo: totL,
            ore: totO,
            km: totK,
            litri: totLitri,
            costoB: totCostoB,
            netto: netto,
            euroOra: totO ? netto / totO : 0,
            consumoMedio: totK ? (totLitri / totK) * 100 : 0
        };
    });
}
function apriResaView(){ 
    document.getElementById('reportView').style.display = 'none'; 
    document.getElementById('resaView').style.display = 'block'; 
    disegnaGraficoResa(); 
}

function chiudiResaView(){ 
    document.getElementById('resaView').style.display = 'none'; 
    document.getElementById('reportView').style.display = 'flex'; 
}

function disegnaGraficoResa(){
    const tag = reportMeseKey || `${(new Date().getMonth()+1).toString().padStart(2,'0')}/${new Date().getFullYear()}`;
    const dati = db.turni.filter(t => t.data.endsWith(tag)).sort((a,b) => a.id - b.id);

    if(!dati.length){
        alert(t('no_data'));
        chiudiResaView();
        return;
    }

    const labels = dati.map(t => t.data.substring(0,5));

    const valsOra = dati.map(t => {
        if(t.ore <= 0) return 0;
        const q = t.km * (t.cons / 100);
        let costoB = q * (t.prezzo || 0);
        if(t.tipoCarburante === 'miscela' && t.percMiscela && t.prezzoOlio){
            costoB += (q * (t.percMiscela / 100)) * t.prezzoOlio;
        }
        const netto = t.lordo - (t.lordo * (db.tax / 100)) - costoB;
        return fromEuro(netto / t.ore);
    });

    const valsKm = dati.map(t => {
        if(t.km <= 0) return 0;
        const q = t.km * (t.cons / 100);
        let costoB = q * (t.prezzo || 0);
        if(t.tipoCarburante === 'miscela' && t.percMiscela && t.prezzoOlio){
            costoB += (q * (t.percMiscela / 100)) * t.prezzoOlio;
        }
        const netto = t.lordo - (t.lordo * (db.tax / 100)) - costoB;
        const distanza = fromKm(t.km);
        return distanza > 0 ? fromEuro(netto / distanza) : 0;
    });

    const ctxO = document.getElementById('chartOra').getContext('2d');
    const ctxK = document.getElementById('chartKm').getContext('2d');

    if(window.myChartOra) window.myChartOra.destroy();
    if(window.myChartKm) window.myChartKm.destroy();

    window.myChartOra = new Chart(ctxO, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
    label: currencySymbol() + '/' + t('hour_short'),
                data: valsOra,
                borderColor: '#00CCBC',
                backgroundColor: 'rgba(0,204,188,0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: true } }
        }
    });
    window.myChartKm = new Chart(ctxK, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: currencySymbol() + '/' + (userSettings.distance === 'miles' ? 'MI' : 'KM'),
                data: valsKm,
                borderColor: '#ff4d4d',
                backgroundColor: 'rgba(255,77,77,0.1)',
                tension: 0.3,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: true } }
        }
    });
}
function selezionaCarburante(tipo, testo) {
    document.getElementById('bTipo').value = tipo;
    document.getElementById('labelCarburante').innerText = getIconaCarburante(tipo) + ' ' + getNomeCarburante(tipo);
    const bP = document.getElementById('bP');
    if (tipo === 'metano') {
        bP.placeholder = currencySymbol() + '/kg';
    } else if (userSettings.volume === 'gallons_us' || userSettings.volume === 'gallons_uk') {
        bP.placeholder = currencySymbol() + '/gal';
    } else {
        bP.placeholder = currencySymbol() + '/L';
    }
    document.getElementById('campiMiscela').style.display = tipo === 'miscela' ? 'block' : 'none';
    localStorage.setItem('ultimo_carburante_benza_' + currentLang, tipo);
    document.getElementById('modalSelectCarburante').style.display = 'none';
}

function formattaPrezzo(input) {
    let valore = input.value.replace(/[^\d]/g, '');
    if (valore.length > 1) {
        input.value = valore.substring(0, 1) + '.' + valore.substring(1, 4);
    } else {
        input.value = valore;
    }
}

function getUnitaCarburante(tipo) {
    if (tipo === 'metano') return 'kg';

    if (userSettings.volume === 'gallons_us') return 'gal';
    if (userSettings.volume === 'gallons_uk') return 'gal(UK)';

    return 'L';
}

function getNomeCarburante(tipo) {
    const nomi = {
        benzina: currentLang === 'it' ? 'Benzina' : 'Gasoline',
        diesel: currentLang === 'it' ? 'Gasolio' : 'Diesel',
        gpl: 'GPL',
        metano: currentLang === 'it' ? 'Metano' : 'CNG',
        miscela: currentLang === 'it' ? 'Miscela' : 'Mix'
    };
    return nomi[tipo] || tipo;
}

function getIconaCarburante(tipo) {
    const icone = {
        benzina: '‚õΩ',
        diesel: 'üõ¢Ô∏è',
        gpl: 'üîµ',
        metano: 'üí®',
        miscela: 'üîÄ'
    };
    return icone[tipo] || '‚õΩ';
}

function _getMezzoLabel(valore) {
    const emojis = { auto: 'üöó', moto: 'üèçÔ∏è', bici: 'üö≤', escooter: '‚ö°', scooter: 'üõ¥' };
    const keyMap = { auto: 'vehicle_car', moto: 'vehicle_motorcycle', bici: 'vehicle_bike', escooter: 'vehicle_escooter', scooter: 'vehicle_scooter' };
    return (emojis[valore] || 'üöó') + ' ' + t(keyMap[valore] || 'vehicle_car');
}

function selezionaMezzo(valore) {
    document.getElementById('tMezzo').value = valore;
    document.getElementById('labelMezzo').innerText = _getMezzoLabel(valore);
    document.getElementById('tC').style.display = valore === 'bici' ? 'none' : 'block';
    localStorage.setItem('ultimo_mezzo_' + currentLang, valore);
    document.getElementById('modalSelectMezzo').style.display = 'none';
}

function selezionaCarburanteTurno(tipo, testo) {
    document.getElementById('tCarburante').value = tipo;
    document.getElementById('labelCarburanteTurno').innerText = getIconaCarburante(tipo) + ' ' + getNomeCarburante(tipo);
    const _cC = document.getElementById('tC');
    if (_cC) {
        if (tipo === 'metano') {
            _cC.placeholder = t('ph_cons_kg');
        } else if (userSettings.consumption === 'km_l') {
            _cC.placeholder = userSettings.distance === 'miles' ? 'MI/GAL' : 'KM/L';
        } else if (userSettings.consumption === 'mpg_us') {
            _cC.placeholder = 'MPG (US)';
        } else if (userSettings.consumption === 'mpg_uk') {
            _cC.placeholder = 'MPG (UK)';
        } else {
            const _v = (userSettings.volume === 'gallons_us' || userSettings.volume === 'gallons_uk') ? 'gal' : 'L';
            const _d = userSettings.distance === 'miles' ? 'mi' : '100km';
            _cC.placeholder = _v + '/' + _d;
        }
    }
    localStorage.setItem('ultimo_carburante_turno_' + currentLang, tipo);
    document.getElementById('modalSelectCarburanteTurno').style.display = 'none';
}

function selezionaCarburanteExtra(tipo, testo) {
    document.getElementById('extraCarburanteInput').value = tipo;
    document.getElementById('labelCarburanteExtra').innerText = getIconaCarburante(tipo) + ' ' + getNomeCarburante(tipo);
    localStorage.setItem('ultimo_carburante_extra_' + currentLang, tipo);
    document.getElementById('modalSelectCarburanteExtra').style.display = 'none';
}
function mostraModalPrezzoIniziale(tipoCarburante) {
    tipoCarburantePrezzoIniziale = tipoCarburante;
    document.getElementById('titlePrezzoIniziale').innerText = `‚õΩ ${getNomeCarburante(tipoCarburante).toUpperCase()}`;
    document.getElementById('campiOlioInizio').style.display = tipoCarburante === 'miscela' ? 'block' : 'none';
    document.getElementById('modalInizio').style.display = 'flex';
}

function confermaPrezzoIniziale() {
    let prezzoInput = parseFloat(document.getElementById('pIniziale').value.replace(',', '.'));
if (!prezzoInput) return;

let prezzo = toEuro(prezzoInput);

if (userSettings.volume === 'gallons_us') {
    prezzo = prezzo / L_PER_GALLON_US;
}

if (userSettings.volume === 'gallons_uk') {
    prezzo = prezzo / L_PER_GALLON_UK;
}

    const rif = {
        id: Date.now() - 1000,
        data: new Date().toLocaleDateString('it-IT'),
        tipo: tipoCarburantePrezzoIniziale,
        euro: 0,
        prezzo: prezzo
    };

    if (tipoCarburantePrezzoIniziale === 'miscela') {
        rif.percMiscela = parseFloat(document.getElementById('pPercMiscelaInizio').value);
        rif.prezzoOlio = parseFloat(document.getElementById('pOlioInizio').value.replace(',', '.'));
    }

    db.rifornimenti.push(rif);
    document.getElementById('modalInizio').style.display = 'none';
    effettuaSalvataggioTurno(prezzo, rif);
}

function salvaTurno() {
    if (isDataFutura(document.getElementById('dateTD').value, document.getElementById('dateTM').value, document.getElementById('dateTY').value)) {
        alert(t('alert_future'));
        return;
    }

    const tipoCarb = document.getElementById('tCarburante').value;
    const rif = db.rifornimenti.filter(r => r.tipo === tipoCarb).sort((a, b) => b.id - a.id)[0];

    if (!rif) {
        mostraModalPrezzoIniziale(tipoCarb);
        return;
    }

    effettuaSalvataggioTurno(rif.prezzo, rif);
}

function consDisplayToL100km(consInput) {
    if (!consInput || consInput <= 0) return 0;
    if (userSettings.consumption === 'mpg_us') return 235.214583 / consInput;
    if (userSettings.consumption === 'mpg_uk') return 282.480936 / consInput;
    if (userSettings.consumption === 'km_l') {
        let val = consInput;
        if (userSettings.volume === 'gallons_us') val = val / L_PER_GALLON_US;
        else if (userSettings.volume === 'gallons_uk') val = val / L_PER_GALLON_UK;
        if (userSettings.distance === 'miles') val = val * KM_PER_MILE;
        return val > 0 ? 100 / val : 0;
    }
    // l_100km (default) ‚Äî input may be gal/100km, gal/100mi, L/100mi
    let val = consInput;
    if (userSettings.distance === 'miles') val = val / KM_PER_MILE;
    if (userSettings.volume === 'gallons_us') val = val * L_PER_GALLON_US;
    else if (userSettings.volume === 'gallons_uk') val = val * L_PER_GALLON_UK;
    return val;
}

function consL100kmToDisplayValue(consL100km) {
    if (!consL100km || consL100km <= 0) return '';
    if (userSettings.consumption === 'mpg_us') return (235.214583 / consL100km).toFixed(1);
    if (userSettings.consumption === 'mpg_uk') return (282.480936 / consL100km).toFixed(1);
    if (userSettings.consumption === 'km_l') {
        let val = 100 / consL100km; // km/L
        if (userSettings.distance === 'miles') val = val / KM_PER_MILE;
        if (userSettings.volume === 'gallons_us') val = val * L_PER_GALLON_US;
        else if (userSettings.volume === 'gallons_uk') val = val * L_PER_GALLON_UK;
        return val.toFixed(1);
    }
    // l_100km: L/100km ‚Üí gal/100km, L/100mi, gal/100mi
    let val = consL100km;
    if (userSettings.distance === 'miles') val = val * KM_PER_MILE;
    if (userSettings.volume === 'gallons_us') val = val / L_PER_GALLON_US;
    else if (userSettings.volume === 'gallons_uk') val = val / L_PER_GALLON_UK;
    return val.toFixed(1);
}

function calcolaMediaConsumoDaStorico(tipoCarburante) {
    const rifs = db.rifornimenti.filter(r => r.tipo === tipoCarburante && r.prezzo > 0 && r.euro > 0);
    const totalLitri = rifs.reduce((sum, r) => sum + (r.euro / r.prezzo), 0);
    const shifts = db.turni.filter(t => t.tipoCarburante === tipoCarburante && t.km > 0);
    const totalKm = shifts.reduce((sum, t) => sum + t.km, 0);
    if (totalKm < 30 || totalLitri <= 0) return null;
    return {
        consL100km: (totalLitri / totalKm) * 100,
        numRif: rifs.length,
        numTurni: shifts.length
    };
}

function aggiornaSuggerimentoConsumo(tipoCarburante) {
    const hint = document.getElementById('consHint');
    const campo = document.getElementById('tC');
    if (!hint || !campo) return;
    if (tipoCarburante === 'bici' || tipoCarburante === 'escooter' || tipoCarburante === 'metano') {
        hint.innerText = '';
        return;
    }
    const result = calcolaMediaConsumoDaStorico(tipoCarburante);
    if (!result) {
        hint.innerText = currentLang === 'it'
            ? '(dati insufficienti ‚Äî inserisci manualmente)'
            : '(insufficient data ‚Äî enter manually)';
        hint.style.color = 'var(--dim)';
        return;
    }
    campo.value = consL100kmToDisplayValue(result.consL100km);
    hint.style.color = 'var(--primary)';
    hint.innerText = currentLang === 'it'
        ? `~media da ${result.numRif} riforniment. ¬∑ ${result.numTurni} turni`
        : `~avg from ${result.numRif} refuel(s) ¬∑ ${result.numTurni} shifts`;
}

function effettuaSalvataggioTurno(prezzo, rif) {
    const dataCompleta = `${document.getElementById('dateTD').value.padStart(2,'0')}/${document.getElementById('dateTM').value.padStart(2,'0')}/${document.getElementById('dateTY').value}`;

    const consInput = parseFloat(document.getElementById('tC').value) || 0;
    const obj = {
        id: Date.now(),
        data: dataCompleta,
        ora: new Date().toLocaleTimeString().substring(0, 5),
        mezzo: document.getElementById('tMezzo').value,
        lordo: parseFloat(document.getElementById('tL').value) || 0,
        ore: parseFloat(document.getElementById('tO').value) || 0,
 km: toKm(parseFloat(document.getElementById('tK').value) || 0),
        cons: consDisplayToL100km(consInput),
        prezzo: prezzo,
        tipoCarburante: document.getElementById('tCarburante').value
    };

    if (obj.tipoCarburante === 'miscela' && rif) {
        obj.percMiscela = rif.percMiscela;
        obj.prezzoOlio = rif.prezzoOlio;
    }

    db.turni.push(obj);
    salvaDB();

    document.getElementById('tL').value = '';
    document.getElementById('tO').value = '';
    document.getElementById('tK').value = '';
    document.getElementById('tC').value = '';
document.getElementById('tCarburante').value = 'benzina';
    chiudiModali();
    mostraModalBackup();
}

function salvaBenza() {
    let euroInput = parseFloat(document.getElementById('bE').value) || 0;
let prezzoInput = parseFloat(document.getElementById('bP').value.replace(',', '.')) || 0;

let euro = toEuro(euroInput);
let prezzo = toEuro(prezzoInput);

    if (euro > 0 && prezzo <= 0) {
    let p = parseFloat(prompt(t('insert_last_price'))?.replace(',', '.') || 0);
    prezzo = toEuro(p);
}

if (userSettings.volume === 'gallons_us') {
    prezzo = prezzo / L_PER_GALLON_US;
}

if (userSettings.volume === 'gallons_uk') {
    prezzo = prezzo / L_PER_GALLON_UK;
}

    if (euro <= 0 || prezzo <= 0) {
        alert(t('alert_missing'));
        return;
    }

    const obj = {
        id: Date.now(),
        data: `${document.getElementById('dateBD').value.padStart(2,'0')}/${document.getElementById('dateBM').value.padStart(2,'0')}/${document.getElementById('dateBY').value}`,
        tipo: document.getElementById('bTipo').value,
        euro: euro,
        prezzo: prezzo
    };

    if (obj.tipo === 'miscela') {
        obj.percMiscela = parseFloat(document.getElementById('bPercMiscela').value);
        obj.prezzoOlio = parseFloat(document.getElementById('bPrezzoOlio').value.replace(',', '.'));
        if (!obj.percMiscela || !obj.prezzoOlio) {
            alert(t('alert_mix'));
            return;
        }
    }
    db.rifornimenti.push(obj);
    salvaDB();

    document.getElementById('bE').value = '';
    document.getElementById('bP').value = '';
    document.getElementById('bPercMiscela').value = '';
    document.getElementById('bPrezzoOlio').value = '';

    chiudiModali();
    mostraModalBackup();
}

function salvaExtraKm() {
    const kmInput = parseFloat(document.getElementById('extraKmInput').value) || 0;
    const km = toKm(kmInput);
    if (km <= 0) return;

    const carb = document.getElementById('extraCarburanteInput').value;
    const rif = db.rifornimenti.filter(r => r.tipo === carb).sort((a, b) => b.id - a.id)[0];

    if (!rif) {
        alert(t('alert_no_refuel'));
        return;
    }

    let mediaInput = parseFloat(document.getElementById('extraMediaInput').value) || 0;
let media = mediaInput;

if (userSettings.consumption === 'km_l' && mediaInput > 0) {
    media = 100 / mediaInput;
}

if (userSettings.consumption === 'mpg_us' && mediaInput > 0) {
    media = 235.214583 / mediaInput;
}

if (userSettings.consumption === 'mpg_uk' && mediaInput > 0) {
    media = 282.480936 / mediaInput;
}

const litri = (km * media) / 100;

    db.extraKm.push({
        id: Date.now(),
        data: `${document.getElementById('dateED').value.padStart(2,'0')}/${document.getElementById('dateEM').value.padStart(2,'0')}/${document.getElementById('dateEY').value}`,
        km: km,
        desc: document.getElementById('extraDescInput').value,
        media: media,
        carburante: carb,
        importo: litri * rif.prezzo
    });

    salvaDB();

    document.getElementById('extraKmInput').value = '';
    document.getElementById('extraMediaInput').value = '';
    document.getElementById('extraDescInput').value = '';

    chiudiModali();
    mostraModalBackup();
}

function mostraAlertGrafico(titolo, messaggio) {
    alert(`${titolo}\n\n${messaggio}`);
}

function chiudiModali() {
    document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
}

function resetModaleElimina() {
    catElimina = '';
    idElimina = null;
    meseDaEliminare = null;
    annoDaEliminare = null;
    document.getElementById('modalElimina').style.display = 'none';
}

function elimina(categoria, id) {
    catElimina = categoria;
    idElimina = id;
    document.getElementById('modalElimina').style.display = 'flex';
}

document.getElementById('btnConfermaElimina').onclick = function() {
    if (catElimina === 'MESE') {
        eseguiEliminazioneMese();
    } else if (catElimina === 'ANNO') {
        eseguiEliminazioneAnno();
    } else {
        db[catElimina] = db[catElimina].filter(x => x.id !== idElimina);
        salvaDB();
        apriStorico();
        resetModaleElimina();
    }
};

function confermaEliminaAnno(anno) {
    annoDaEliminare = anno;
    catElimina = 'ANNO';
    document.querySelector('#modalElimina p').innerText = `${t('delete_year')} ${anno}?`;
    document.getElementById('modalElimina').style.display = 'flex';
}

function eseguiEliminazioneAnno() {
    if (annoDaEliminare) {
        db.turni = db.turni.filter(t => !t.data.endsWith(annoDaEliminare));
        db.rifornimenti = db.rifornimenti.filter(r => !r.data.endsWith(annoDaEliminare));
        db.extraKm = db.extraKm.filter(e => !e.data.endsWith(annoDaEliminare));
        
        salvaDB();
        apriStorico();
        resetModaleElimina();
    }
}
function mostraModalBackup() {
    document.getElementById('modalBackupExport').style.display = 'flex';
}

function salvaBackup() {
    const dataObj = {
        timestamp: Date.now(),
        db: db
    };
    const blob = new Blob([JSON.stringify(dataObj)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `backup_${new Date().toISOString().slice(0, 10)}.json`;
    a.click();
}

function accettaBackup() {
    salvaBackup();
    document.getElementById('modalBackupExport').style.display = 'none';
}

function rifiutaBackup() {
    document.getElementById('modalBackupExport').style.display = 'none';
}

document.getElementById("fileBackup").addEventListener("change", function (e) {
    const reader = new FileReader();
    reader.onload = function (ev) {
        try {
            db = JSON.parse(ev.target.result).db;
            salvaDB();
            location.reload();
        } catch (err) {
            alert(t('backup_error'));
        }
    };
    reader.readAsText(e.target.files[0]);
});

window.onload = function() {

    aggiornaDBConTipoCarburante();

    const ultimoMezzo = localStorage.getItem('ultimo_mezzo_' + currentLang) || 'auto';
const _selMezzo = document.getElementById('tMezzo');
if (_selMezzo) _selMezzo.value = ultimoMezzo;
const _lblMezzo = document.getElementById('labelMezzo');
if (_lblMezzo) _lblMezzo.innerText = _getMezzoLabel(ultimoMezzo);

    setTimeout(() => {
        if (typeof updateInterface === "function") {
            updateInterface();
        }
    }, 200);

    setInterval(() => {
        const n = new Date();
        const clock = document.getElementById('liveClock');
        if (clock) {
            clock.innerText =
                `${n.getDate().toString().padStart(2,'0')}/` +
                `${(n.getMonth()+1).toString().padStart(2,'0')}/` +
                `${n.getFullYear().toString().substring(2)} ` +
                `${n.toLocaleTimeString()}`;
        }
    }, 1000);

    const ultimoAvviso = localStorage.getItem('ultimo_avviso_fine_mese');
    const meseCorrente = `${new Date().getMonth() + 1}/${new Date().getFullYear()}`;

    if (new Date().getDate() === 1 && ultimoAvviso !== meseCorrente) {
        setTimeout(() => {
            const modal = document.getElementById('modalFineMese');
            if (modal) modal.style.display = 'flex';
        }, 2000);
        localStorage.setItem('ultimo_avviso_fine_mese', meseCorrente);
    }

    const inputs = document.querySelectorAll('.modal input');
    inputs.forEach(input => {
        if (input.type === 'checkbox' || input.type === 'radio' || input.type === 'hidden') return;
        const parentFiscoSettings = input.closest('#modalFiscoSettings');
        if (parentFiscoSettings) {
            input.addEventListener('focus', () => {
                const content = input.closest('.modal-content');
                if (content) {
                    content.style.maxHeight = '52vh';
                    setTimeout(() => { input.scrollIntoView({ block: 'center', behavior: 'smooth' }); }, 80);
                }
            });
            input.addEventListener('blur', () => {
                const content = input.closest('.modal-content');
                if (content) content.style.maxHeight = '90vh';
            });
        } else {
            input.addEventListener('focus', () => {
                const content = input.closest('.modal-content');
                if (content) content.style.transform = 'translateY(-170px)';
            });
            input.addEventListener('blur', () => {
                const content = input.closest('.modal-content');
                if (content) content.style.transform = 'translateY(0)';
            });
        }
    });

};
function stampaDirettaDaAlert() {
    chiudiModali();
    apriReport();
    window.print();
}

function stampaPagina() {
    const rv = document.getElementById('reportView');
    if (!rv.style.display || rv.style.display === 'none') {
        apriReport(reportMeseKey || null);
    }
    rv.style.display = 'flex';
    window.print();
}
</script>
<div id="modalSettings" class="modal no-print">
    <div class="modal-content" style="border-color: var(--primary); max-height: 90vh; overflow-y: auto;">

        <h3 style="font-size:16px; text-align:center; margin-bottom:5px; color: var(--primary);">
            üá∫üá∏ ENGLISH SETTINGS
        </h3>
        <p style="font-size:11px; color: var(--dim); text-align:center; margin-bottom:15px; text-transform:uppercase; letter-spacing:1px;">
            Units &amp; Preferences
        </p>

        <div style="display:flex; flex-direction:column; gap:10px; font-size:13px;">

            <label style="color: var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px; margin-bottom:-4px;">Distance</label>
            <select id="settingsDistance" style="padding:10px; background:#252525; color:#fff; border:1px solid #444; border-radius:10px; font-size:14px;">
                <option value="km">Kilometers (km)</option>
                <option value="miles">Miles (mi)</option>
            </select>

            <label style="color: var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px; margin-bottom:-4px;">Volume</label>
            <select id="settingsVolume" style="padding:10px; background:#252525; color:#fff; border:1px solid #444; border-radius:10px; font-size:14px;">
                <option value="liters">Liters (L)</option>
                <option value="gallons_us">Gallons US (gal)</option>
                <option value="gallons_uk">Gallons UK (gal)</option>
            </select>

            <label style="color: var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px; margin-bottom:-4px;">Mass</label>
            <select id="settingsMass" style="padding:10px; background:#252525; color:#fff; border:1px solid #444; border-radius:10px; font-size:14px;">
                <option value="kg">Kilograms (kg)</option>
                <option value="lbs">Pounds (lbs)</option>
            </select>

            <label style="color: var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px; margin-bottom:-4px;">Currency</label>
            <select id="settingsCurrency" style="padding:10px; background:#252525; color:#fff; border:1px solid #444; border-radius:10px; font-size:14px;">
                <option value="EUR">Euro (‚Ç¨)</option>
                <option value="USD">US Dollar ($)</option>
                <option value="GBP">British Pound (¬£)</option>
            </select>

            <label style="color: var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px; margin-bottom:-4px;">Consumption Format</label>
            <select id="settingsConsumption" style="padding:10px; background:#252525; color:#fff; border:1px solid #444; border-radius:10px; font-size:14px;">
                <option value="l_100km">L/100km</option>
                <option value="km_l">km/L (efficiency)</option>
                <option value="mpg_us">MPG (US)</option>
                <option value="mpg_uk">MPG (UK)</option>
            </select>

        </div>

        <button class="btn-modal btn-save" onclick="salvaSettingsEChiudi()" style="margin-top:18px;">
            ‚úî SAVE &amp; APPLY
        </button>
        <button class="btn-modal btn-close" onclick="chiudiModalSettings()" style="margin-top:6px;">
            CLOSE
        </button>

    </div>
</div>
<script>
function chiudiModalSettings() {
    document.getElementById('modalSettings').style.display = 'none';
}

function salvaSettingsEChiudi() {
    const d = document.getElementById('settingsDistance');
    const v = document.getElementById('settingsVolume');
    const m = document.getElementById('settingsMass');
    const c = document.getElementById('settingsCurrency');
    const k = document.getElementById('settingsConsumption');

    if (d) userSettings.distance    = d.value;
    if (v) userSettings.volume      = v.value;
    if (m) userSettings.mass        = m.value;
    if (c) userSettings.currency    = c.value;
    if (k) userSettings.consumption = k.value;

    salvaUserSettings();
    chiudiModalSettings();
}

document.getElementById('modalSettings').addEventListener('click', function(e) {
    if (e.target === this) {
        chiudiModalSettings();
    }
});

function apriLanguageSettings() {
    apriLanguageEN();
}
// Inizializzazione app all'avvio
aggiornaDBConTipoCarburante();
aggiornaLabelSettings();

const flagIT = document.getElementById('flagIT');
const flagEN = document.getElementById('flagEN');
if (flagIT && flagEN) {
    flagIT.style.opacity = currentLang === 'it' ? '1' : '0.4';
    flagEN.style.opacity = currentLang === 'en' ? '1' : '0.4';
}

updateInterface();
calcola();
</script>
<!-- ===== FISCO MODULE v3.2 ===== -->
<style>
#fiscoView {
    display: none;
    position: fixed;
    inset: 0;
    z-index: 9100;
    background: var(--bg);
    flex-direction: column;
    padding: 15px;
    overflow: hidden;
}
.fisco-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.fisco-title { font-size: 20px; font-weight: 900; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
.fisco-scroll { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
.fisco-card { background: var(--card); border: 1px solid #333; border-radius: 12px; padding: 12px; margin-bottom: 8px; }
.fisco-card-title { font-size: 10px; color: var(--dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; font-weight: bold; }
.fisco-grid3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 8px; }
.fisco-mini-card { background: var(--card); border: 1px solid #333; border-radius: 10px; padding: 10px; text-align: center; }
.fisco-mini-label { font-size: 8px; color: var(--dim); text-transform: uppercase; font-weight: bold; margin-bottom: 4px; }
.fisco-mini-val { font-size: 14px; font-weight: 900; color: var(--text); }
.fisco-warning { background: #2a1a00; border: 1px solid var(--orange); border-radius: 10px; padding: 10px; margin-bottom: 8px; font-size: 12px; color: var(--orange); text-align: center; }
.fisco-warning.critical { background: #2a0000; border-color: var(--accent); color: var(--accent); }
.fattura-item { background: #0f0f0f; border: 1px solid #333; border-radius: 10px; padding: 10px 12px; margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center; }
.fattura-num { font-size: 11px; color: var(--dim); }
.fattura-importo { font-size: 16px; font-weight: 900; color: var(--primary); }
.fattura-stato { font-size: 9px; font-weight: bold; text-transform: uppercase; padding: 2px 6px; border-radius: 4px; }
.fattura-stato.verificata { background: #004d40; color: #00CCBC; }
.fattura-stato.da_verificare { background: #333; color: #aaa; }
.scad-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #222; font-size: 12px; }
.scad-data { color: var(--primary); font-weight: bold; min-width: 80px; }
.scad-desc { color: var(--text); flex: 1; padding: 0 8px; }
.scad-imp { color: var(--accent); font-weight: bold; }
.btn-fisco-action { background: var(--primary); color: #000; border: none; border-radius: 10px; padding: 10px 15px; font-weight: 900; font-size: 12px; text-transform: uppercase; cursor: pointer; }
.btn-fisco-secondary { background: #252525; color: var(--text); border: 1px solid #444; border-radius: 10px; padding: 10px 12px; font-weight: bold; font-size: 12px; text-transform: uppercase; cursor: pointer; }
.fisco-actions-row { display: flex; gap: 8px; margin-bottom: 8px; }
.fisco-anno-sel { background: #252525; color: #fff; padding: 8px 12px; border-radius: 10px; border: 1px solid #444; font-size: 14px; flex: 1; }
.disclaimer-fisco { font-size: 10px; color: var(--dim); text-align: center; padding: 10px; font-style: italic; }
</style>
<div id="fiscoView" class="no-print">
    <div class="fisco-header">
        <div class="fisco-title"><i class="fas fa-piggy-bank" style="margin-right:8px;"></i>FISCO</div>
        <div style="display:flex; gap:8px;">
            <button class="btn-fisco-secondary" onclick="apriFiscoSettings()" style="font-size:11px; padding:8px 10px;">‚öôÔ∏è PROFILO</button>
            <button class="btn-fisco-secondary" onclick="backupFiscale()" style="font-size:11px; padding:8px 10px;">üì¶</button>
            <button class="btn-fisco-secondary" onclick="chiudiFisco()" style="font-size:11px; padding:8px 10px;">‚úï</button>
        </div>
    </div>
    <div class="fisco-actions-row">
        <select id="fiscoAnnoSel" class="fisco-anno-sel" onchange="renderFisco()"></select>
        <button class="btn-fisco-action" onclick="apriNuovaFattura()">+ FATTURA</button>
    </div>
    <div id="fiscoWarning" style="display:none;" class="fisco-warning"></div>
    <div class="fisco-grid3">
        <div class="fisco-mini-card">
            <div class="fisco-mini-label">LORDO</div>
            <div class="fisco-mini-val" id="fLordo">‚Ç¨ 0,00</div>
        </div>
        <div class="fisco-mini-card">
            <div class="fisco-mini-label">INPS</div>
            <div class="fisco-mini-val" id="fINPS" style="color:var(--orange);">‚Ç¨ 0,00</div>
        </div>
        <div class="fisco-mini-card">
            <div class="fisco-mini-label">IMPOSTA</div>
            <div class="fisco-mini-val" id="fImposta" style="color:var(--accent);">‚Ç¨ 0,00</div>
        </div>
    </div>
    <div class="fisco-grid3">
        <div class="fisco-mini-card">
            <div class="fisco-mini-label">NETTO REALE</div>
            <div class="fisco-mini-val" id="fNetto" style="color:var(--primary);">‚Ç¨ 0,00</div>
        </div>
        <div class="fisco-mini-card">
            <div class="fisco-mini-label">ACCANTONAMENTO</div>
            <div class="fisco-mini-val" id="fAccant" style="color:#aaa;">‚Ç¨ 0,00</div>
        </div>
        <div class="fisco-mini-card">
            <div class="fisco-mini-label">BOLLI TOT.</div>
            <div class="fisco-mini-val" id="fBolli">‚Ç¨ 0,00</div>
        </div>
    </div>
    <div class="fisco-scroll">
        <div id="fiscoServizioBtn" style="display:none; margin-bottom:8px;"></div>
        <div class="fisco-card">
            <div class="fisco-card-title">üìÖ SCADENZARIO</div>
            <div id="fiscoScadenzario"></div>
        </div>
        <div class="fisco-card">
            <div class="fisco-card-title">üßæ FATTURE ANNO SELEZIONATO</div>
            <div id="fiscoListaFatture"></div>
        </div>
        <div class="disclaimer-fisco">‚ö†Ô∏è Questo strumento √® un simulatore fiscale basato sui dati inseriti manualmente. Non sostituisce il commercialista.</div>
        <div style="height:20px;"></div>
    </div>
</div>

<div id="modalFattura" class="modal no-print">
    <div class="modal-content" style="border-color:var(--primary); max-height:90vh; overflow-y:auto;">
        <h3 style="font-size:16px; color:var(--primary); text-align:center; margin-top:0;" id="titleModalFattura">NUOVA FATTURA</h3>
        <input type="hidden" id="fatturaEditId" value="">
        <label style="color:var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:4px;">N¬∞ Fattura</label>
        <input type="text" id="fNumero" placeholder="Es. 2025/001" autocomplete="off">
        <label style="color:var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:4px;">Data fattura</label>
        <input type="date" id="fData" style="width:100%; padding:12px; background:var(--input-bg); border:1px solid #444; color:#fff; border-radius:12px; margin-bottom:10px; outline:none; font-size:16px;">
        <label style="color:var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:4px;">Importo lordo (‚Ç¨)</label>
        <input type="number" id="fImporto" placeholder="0.00" step="0.01" inputmode="decimal">
        <label style="color:var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:4px;">Piattaforma</label>
        <input type="text" id="fPiattaforma" placeholder="Es. Glovo, Deliveroo..." autocomplete="off">
        <label style="color:var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:4px;">Marca da bollo</label>
        <select id="fBollo" style="width:100%; padding:12px; background:var(--input-bg); border:1px solid #444; color:#fff; border-radius:12px; margin-bottom:10px; font-size:14px;">
            <option value="auto">Auto (2‚Ç¨ se importo &gt; 77,47‚Ç¨)</option>
            <option value="0">0‚Ç¨ (nessuna)</option>
            <option value="2">2‚Ç¨</option>
        </select>
        <label style="color:var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:4px;">Stato</label>
        <select id="fStato" style="width:100%; padding:12px; background:var(--input-bg); border:1px solid #444; color:#fff; border-radius:12px; margin-bottom:10px; font-size:14px;">
            <option value="da_verificare">Da verificare</option>
            <option value="verificata">Verificata</option>
        </select>
        <button class="btn-modal btn-save" onclick="salvaFattura()">SALVA</button>
        <button class="btn-modal btn-close" onclick="document.getElementById('modalFattura').style.display='none'">ANNULLA</button>
    </div>
</div>

<div id="modalFiscoSettings" class="modal no-print">
    <div class="modal-content" style="border-color:var(--primary); max-height:90vh; overflow-y:auto;">
        <h3 style="font-size:16px; color:var(--primary); text-align:center; margin-top:0;">‚öôÔ∏è PROFILO FISCALE</h3>
        <label style="color:var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:4px;">Anno fiscale attivo</label>
        <input type="number" id="fsAnno" placeholder="Es. 2025" inputmode="numeric">
        <label style="color:var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:4px;">Coefficiente redditivit√† (%)</label>
        <input type="number" id="fsCoeff" placeholder="40‚Äì86" step="0.01" inputmode="decimal">
        <label style="color:var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:4px;">Aliquota imposta sostitutiva (%)</label>
        <input type="number" id="fsImposta" placeholder="5‚Äì15" step="0.01" inputmode="decimal">
        <label style="color:var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:4px;">Aliquota INPS (%)</label>
        <input type="number" id="fsINPS" placeholder="20‚Äì30" step="0.01" inputmode="decimal">
        <label style="color:var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px; display:block; margin:8px 0 6px;">
            <input type="checkbox" id="fsRidINPS" style="margin-right:6px; width:auto;">
            Riduzione INPS 35%
        </label>
        <label style="color:var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:4px;">INPS gi√† versato (‚Ç¨)</label>
        <input type="number" id="fsInpsVers" placeholder="0.00" step="0.01" inputmode="decimal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; margin-top:4px;">
            <span style="color:var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px;">Anno fiscale</span>
            <select id="fsChiuso" style="padding:8px; background:var(--input-bg); border:1px solid #444; color:#fff; border-radius:8px; font-size:13px;">
                <option value="false">Aperto</option>
                <option value="true">Chiuso</option>
            </select>
        </div>
        <hr style="border-color:#333; margin:12px 0;">
        <label style="color:var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px; display:flex; align-items:center; justify-content:space-between; margin-bottom:10px;">
            <span>Usa servizio esterno</span>
            <input type="checkbox" id="fsUsaServizio" style="width:auto; margin:0; transform:scale(1.4);" onchange="toggleFsServizio(this.checked)">
        </label>
        <label id="lblFsNome" style="color:var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:4px; opacity:0.4;">Nome servizio</label>
        <input type="text" id="fsNomeServizio" placeholder="Es. Taxman, Fiscozen..." autocomplete="off" disabled style="opacity:0.4;">
        <label id="lblFsUrl" style="color:var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:4px; opacity:0.4;">URL servizio</label>
        <input type="url" id="fsUrlServizio" placeholder="https://..." autocomplete="off" inputmode="url" disabled style="opacity:0.4;">
        <hr style="border-color:#333; margin:12px 0;">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
            <span style="color:var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px;">Usa servizio esterno</span>
            <input type="checkbox" id="fsUsaServizio" style="width:auto; margin:0; transform:scale(1.4);" onchange="toggleFsServizio(this.checked)">
        </div>
        <label id="lblFsNome" style="color:var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:4px; opacity:0.35;">Nome servizio</label>
        <input type="text" id="fsNomeServizio" placeholder="Es. Taxman, Fiscozen..." autocomplete="off" disabled style="opacity:0.35; pointer-events:none;">
        <label id="lblFsUrl" style="color:var(--dim); font-size:10px; text-transform:uppercase; letter-spacing:1px; display:block; margin-bottom:4px; opacity:0.35;">URL servizio</label>
        <input type="url" id="fsUrlServizio" placeholder="https://..." autocomplete="off" inputmode="url" disabled style="opacity:0.35; pointer-events:none;">
        <button class="btn-modal btn-save" onclick="salvaFiscoSettings()">SALVA</button>
        <button class="btn-modal btn-close" onclick="document.getElementById('modalFiscoSettings').style.display='none'">ANNULLA</button>
    </div>
</div>
<div id="modalFiscoUnlock" class="modal no-print">
    <div class="modal-content" style="border-color:var(--accent);">
        <h3 style="color:var(--accent); font-size:16px; margin-top:0;">‚ö†Ô∏è FATTURA VERIFICATA</h3>
        <p style="font-size:13px; color:var(--text); margin:15px 0;">Questa fattura √® verificata. Sei sicuro di voler apportare modifiche?</p>
        <input type="hidden" id="unlockFatturaId" value="">
        <div class="confirm-buttons">
            <button class="btn-confirm-cancel" onclick="document.getElementById('modalFiscoUnlock').style.display='none'">ANNULLA</button>
            <button class="btn-confirm-ok" style="background:var(--accent); color:white;" onclick="confermaSbloccoFattura()">MODIFICA</button>
        </div>
    </div>
</div>

<div id="modalFiscoElimina" class="modal no-print">
    <div class="modal-content" style="border-color:var(--accent);">
        <h3 style="color:var(--accent); font-size:16px; margin-top:0;">üóëÔ∏è ELIMINA FATTURA</h3>
        <p style="font-size:13px; color:var(--text); margin:15px 0;">Sei sicuro di voler eliminare questa fattura?</p>
        <input type="hidden" id="eliminaFatturaId" value="">
        <div class="confirm-buttons">
            <button class="btn-confirm-cancel" onclick="document.getElementById('modalFiscoElimina').style.display='none'">ANNULLA</button>
            <button class="btn-confirm-ok" style="background:var(--accent); color:white;" onclick="confermaEliminaFattura()">ELIMINA</button>
        </div>
    </div>
</div>

<script>
const FISCO_KEY = 'fisco_invoices_v1_it';
const FISCO_SETTINGS_KEY = 'fisco_settings_v1_it';
const FISCO_SETTINGS_LOG_KEY = 'fisco_settings_log_v1_it';
const FISCO_BACKUP_KEY = 'fisco_backup_v1_it';

function roundFiscal(value) { return Math.round((value + Number.EPSILON) * 100) / 100; }

function loadFiscoFatture() {
    try { return JSON.parse(localStorage.getItem(FISCO_KEY)) || []; } catch(e) { return []; }
}

function saveFiscoFatture(arr) {
    localStorage.setItem(FISCO_KEY, JSON.stringify(arr));
}

function loadFiscoSettings() {
    var defaults = { coefficiente: 78, aliquotaImposta: 15, aliquotaINPS: 26.23, riduzioneINPS: false, inpsVersato: 0, annoFiscaleAttivo: new Date().getFullYear(), annoFiscaleChiuso: false, usaServizioEsterno: false, nomeServizio: '', urlServizio: '' };
    try {
        var s = JSON.parse(localStorage.getItem(FISCO_SETTINGS_KEY));
        return s ? Object.assign({}, defaults, s) : defaults;
    } catch(e) { return defaults; }
}

function saveFiscoSettings(newSettings, oldSettings) {
    var log = JSON.parse(localStorage.getItem(FISCO_SETTINGS_LOG_KEY)) || [];
    Object.keys(newSettings).forEach(function(k) {
        if (oldSettings && oldSettings[k] !== newSettings[k]) {
            log.push({ campoModificato: k, valorePrecedente: oldSettings[k], nuovoValore: newSettings[k], timestamp: new Date().toISOString() });
        }
    });
    localStorage.setItem(FISCO_SETTINGS_LOG_KEY, JSON.stringify(log));
    localStorage.setItem(FISCO_SETTINGS_KEY, JSON.stringify(newSettings));
}

function calcolaFiscale(fatture, settings) {
    var lordo = 0;
    fatture.forEach(function(f) { lordo += f.importoLordo; });
    lordo = roundFiscal(lordo);
    var redditoImponibile = roundFiscal(lordo * settings.coefficiente / 100);
    var aliquotaINPSeff = settings.riduzioneINPS ? settings.aliquotaINPS * 0.65 : settings.aliquotaINPS;
    var inps = roundFiscal(redditoImponibile * aliquotaINPSeff / 100);
    var imposta = roundFiscal((redditoImponibile - inps) * settings.aliquotaImposta / 100);
    var totaleBolli = 0;
    fatture.forEach(function(f) {
        if (f.marcaDaBollo === 'auto' || f.marcaDaBollo === undefined) { totaleBolli += (f.importoLordo > 77.47 ? 2 : 0); }
        else { totaleBolli += parseFloat(f.marcaDaBollo) || 0; }
    });
    totaleBolli = roundFiscal(totaleBolli);
    var nettoReale = roundFiscal(lordo - inps - imposta - totaleBolli);
    var accantonamento = roundFiscal(lordo * 0.30);
    var saldo = roundFiscal(inps + imposta - (settings.inpsVersato || 0));
    var acconto1 = roundFiscal(saldo * 0.40);
    var acconto2 = roundFiscal(saldo * 0.60);
    return { lordo: lordo, redditoImponibile: redditoImponibile, inps: inps, imposta: imposta, totaleBolli: totaleBolli, nettoReale: nettoReale, accantonamento: accantonamento, saldo: saldo, acconto1: acconto1, acconto2: acconto2 };
}

function fmtEuro(v) { return '‚Ç¨ ' + v.toFixed(2).replace('.', ','); }

function formatDataFattura(d) {
    if (!d) return '';
    var p = d.split('-');
    return p.length === 3 ? p[2] + '/' + p[1] + '/' + p[0] : d;
}

function getAnniDisponibili() {
    var fatture = loadFiscoFatture();
    var settings = loadFiscoSettings();
    var anni = {};
    anni[settings.annoFiscaleAttivo] = true;
    anni[new Date().getFullYear()] = true;
    fatture.forEach(function(f) { anni[f.annoFiscale] = true; });
    return Object.keys(anni).map(Number).sort(function(a, b) { return b - a; });
}

function apriFisco() {
    if (currentLang !== 'it') return;
    var sel = document.getElementById('fiscoAnnoSel');
    var settings = loadFiscoSettings();
    var anni = getAnniDisponibili();
    sel.innerHTML = anni.map(function(a) {
        return '<option value="' + a + '"' + (a === settings.annoFiscaleAttivo ? ' selected' : '') + '>' + a + '</option>';
    }).join('');
    document.getElementById('fiscoView').style.display = 'flex';
    renderFisco();
}

function chiudiFisco() {
    document.getElementById('fiscoView').style.display = 'none';
}
function renderFisco() {
    var sel = document.getElementById('fiscoAnnoSel');
    var anno = parseInt(sel.value);
    var settings = loadFiscoSettings();
    var tutteFatture = loadFiscoFatture();
    var fatture = tutteFatture.filter(function(f) { return f.annoFiscale === anno; });
    var calc = calcolaFiscale(fatture, settings);
    document.getElementById('fLordo').innerText = fmtEuro(calc.lordo);
    document.getElementById('fINPS').innerText = fmtEuro(calc.inps);
    document.getElementById('fImposta').innerText = fmtEuro(calc.imposta);
    document.getElementById('fNetto').innerText = fmtEuro(calc.nettoReale);
    document.getElementById('fAccant').innerText = fmtEuro(calc.accantonamento);
    document.getElementById('fBolli').innerText = fmtEuro(calc.totaleBolli);
    var w = document.getElementById('fiscoWarning');
    if (calc.lordo >= 85000) {
        w.style.display = ''; w.className = 'fisco-warning critical';
        w.innerHTML = 'üö® SOGLIA 85.000‚Ç¨ SUPERATA. Regime forfettario non applicabile!';
    } else if (calc.lordo >= 80000) {
        w.style.display = ''; w.className = 'fisco-warning critical';
        w.innerHTML = '‚ö†Ô∏è ATTENZIONE: Superati 80.000‚Ç¨. Avvicinamento alla soglia limite.';
    } else if (calc.lordo >= 65000) {
        w.style.display = ''; w.className = 'fisco-warning';
        w.innerHTML = '‚ö†Ô∏è AVVISO: Superati 65.000‚Ç¨. Monitorare il fatturato.';
    } else { w.style.display = 'none'; }
    renderScadenzario(anno, calc);
    renderListaFatture(fatture, anno, settings);

    var sbtn = document.getElementById('fiscoServizioBtn');
    if (sbtn) {
        if (settings.usaServizioEsterno && settings.nomeServizio && settings.urlServizio) {
            var url = settings.urlServizio;
            if (url.indexOf('http') !== 0) url = 'https://' + url;
            sbtn.style.display = '';
            sbtn.innerHTML = '<a href="' + url + '" target="_blank" rel="noopener" style="display:flex; align-items:center; justify-content:center; gap:10px; background:linear-gradient(135deg,#004d40,#00695c); border:1px solid var(--primary); border-radius:12px; padding:13px 15px; text-decoration:none; color:#fff; font-weight:900; font-size:13px; text-transform:uppercase; letter-spacing:0.5px;"><i class="fas fa-external-link-alt" style="color:var(--primary); font-size:16px;"></i>' + settings.nomeServizio + '<i class="fas fa-chevron-right" style="color:var(--primary); font-size:12px; margin-left:auto;"></i></a>';
        } else {
            sbtn.style.display = 'none';
            sbtn.innerHTML = '';
        }
    }
}

function primoGiornoLavorativo(date) {
    var d = new Date(date);
    var dow = d.getDay();
    if (dow === 0) d.setDate(d.getDate() + 1);
    else if (dow === 6) d.setDate(d.getDate() + 2);
    return d.toLocaleDateString('it-IT', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function renderScadenzario(anno, calc) {
    var el = document.getElementById('fiscoScadenzario');
    if (calc.lordo === 0) { el.innerHTML = '<div style="color:var(--dim);font-size:12px;padding:8px 0;">Nessun dato disponibile.</div>'; return; }
    var bolloQ = roundFiscal(calc.totaleBolli / 4);
    var items = [
        { data: primoGiornoLavorativo(new Date(anno + 1, 5, 30)), desc: 'Saldo IRPEF + 1¬∞ Acconto (40%)', imp: roundFiscal(calc.saldo + calc.acconto1) },
        { data: primoGiornoLavorativo(new Date(anno + 1, 10, 30)), desc: '2¬∞ Acconto IRPEF (60%)', imp: calc.acconto2 },
        { data: primoGiornoLavorativo(new Date(anno, 3, 16)), desc: 'Bollo Trimestrale Q1', imp: bolloQ },
        { data: primoGiornoLavorativo(new Date(anno, 6, 16)), desc: 'Bollo Trimestrale Q2', imp: bolloQ },
        { data: primoGiornoLavorativo(new Date(anno, 9, 16)), desc: 'Bollo Trimestrale Q3', imp: bolloQ },
        { data: primoGiornoLavorativo(new Date(anno + 1, 0, 16)), desc: 'Bollo Trimestrale Q4', imp: bolloQ }
    ];
    el.innerHTML = items.map(function(i) {
        return '<div class="scad-item"><span class="scad-data">' + i.data + '</span><span class="scad-desc">' + i.desc + '</span><span class="scad-imp">' + fmtEuro(i.imp) + '</span></div>';
    }).join('');
}

function renderListaFatture(fatture, anno, settings) {
    var el = document.getElementById('fiscoListaFatture');
    var chiuso = settings.annoFiscaleChiuso && settings.annoFiscaleAttivo === anno;
    if (fatture.length === 0) { el.innerHTML = '<div style="color:var(--dim);font-size:12px;padding:8px 0;text-align:center;">Nessuna fattura per questo anno.</div>'; return; }
    var sorted = fatture.slice().sort(function(a, b) { return b.dataFattura.localeCompare(a.dataFattura); });
    el.innerHTML = sorted.map(function(f) {
        var bolloCalc = (f.marcaDaBollo === 'auto' || f.marcaDaBollo === undefined) ? (f.importoLordo > 77.47 ? 2 : 0) : (parseFloat(f.marcaDaBollo) || 0);
        var btns = chiuso ? '' : '<button style="background:none;border:1px solid #444;color:#aaa;border-radius:5px;padding:3px 8px;font-size:10px;cursor:pointer;" onclick="apriModificaFattura(\'' + f.id + '\')">‚úèÔ∏è</button><button style="background:none;border:1px solid var(--accent);color:var(--accent);border-radius:5px;padding:3px 8px;font-size:10px;cursor:pointer;margin-top:4px;" onclick="richiestaEliminaFattura(\'' + f.id + '\')">üóëÔ∏è</button>';
        return '<div class="fattura-item"><div style="flex:1;"><div class="fattura-num">' + f.numeroFattura + ' ‚Ä¢ ' + f.piattaforma + ' ‚Ä¢ ' + formatDataFattura(f.dataFattura) + '</div><div class="fattura-importo">' + fmtEuro(f.importoLordo) + '</div><div style="font-size:10px;color:var(--dim);">Bollo: ‚Ç¨' + bolloCalc.toFixed(2) + '</div></div><div style="display:flex;flex-direction:column;align-items:flex-end;gap:5px;"><span class="fattura-stato ' + f.stato + '">' + (f.stato === 'verificata' ? '‚úî Verificata' : '‚óé Da verificare') + '</span>' + btns + '</div></div>';
    }).join('');
}

function apriNuovaFattura() {
    var settings = loadFiscoSettings();
    if (settings.annoFiscaleChiuso) { alert('Anno fiscale chiuso. Sblocca il profilo per inserire nuove fatture.'); return; }
    document.getElementById('titleModalFattura').innerText = 'NUOVA FATTURA';
    document.getElementById('fatturaEditId').value = '';
    document.getElementById('fNumero').value = '';
    document.getElementById('fData').value = new Date().toISOString().split('T')[0];
    document.getElementById('fImporto').value = '';
    document.getElementById('fPiattaforma').value = '';
    document.getElementById('fBollo').value = 'auto';
    document.getElementById('fStato').value = 'da_verificare';
    document.getElementById('modalFattura').style.display = 'flex';
}

function apriModificaFattura(id) {
    var fatture = loadFiscoFatture();
    var f = fatture.find(function(x) { return x.id === id; });
    if (!f) return;
    if (f.stato === 'verificata') {
        document.getElementById('unlockFatturaId').value = id;
        document.getElementById('modalFiscoUnlock').style.display = 'flex';
        return;
    }
    _popolaModalFattura(f);
}

function confermaSbloccoFattura() {
    document.getElementById('modalFiscoUnlock').style.display = 'none';
    var id = document.getElementById('unlockFatturaId').value;
    var f = loadFiscoFatture().find(function(x) { return x.id === id; });
    if (f) _popolaModalFattura(f);
}

function _popolaModalFattura(f) {
    document.getElementById('titleModalFattura').innerText = 'MODIFICA FATTURA';
    document.getElementById('fatturaEditId').value = f.id;
    document.getElementById('fNumero').value = f.numeroFattura;
    document.getElementById('fData').value = f.dataFattura;
    document.getElementById('fImporto').value = f.importoLordo;
    document.getElementById('fPiattaforma').value = f.piattaforma;
    document.getElementById('fBollo').value = (f.marcaDaBollo !== undefined) ? String(f.marcaDaBollo) : 'auto';
    document.getElementById('fStato').value = f.stato;
    document.getElementById('modalFattura').style.display = 'flex';
}
function salvaFattura() {
    var numero = document.getElementById('fNumero').value.trim();
    var data = document.getElementById('fData').value;
    var importo = parseFloat(document.getElementById('fImporto').value);
    var piattaforma = document.getElementById('fPiattaforma').value.trim();
    var bolloVal = document.getElementById('fBollo').value;
    var stato = document.getElementById('fStato').value;
    var editId = document.getElementById('fatturaEditId').value;
    if (!numero || !data || isNaN(importo) || importo <= 0 || !piattaforma) { alert('Compila tutti i campi obbligatori. Importo deve essere > 0.'); return; }
    if (data > new Date().toISOString().split('T')[0]) { alert('Non puoi inserire una data futura.'); return; }
    var annoFattura = parseInt(data.split('-')[0]);
    var fatture = loadFiscoFatture();
    var now = new Date().toISOString();
    if (editId) {
        var idx = fatture.findIndex(function(x) { return x.id === editId; });
        if (idx === -1) return;
        fatture[idx].numeroFattura = numero; fatture[idx].dataFattura = data;
        fatture[idx].importoLordo = roundFiscal(importo);
        fatture[idx].marcaDaBollo = (bolloVal === 'auto') ? 'auto' : parseFloat(bolloVal);
        fatture[idx].annoFiscale = annoFattura; fatture[idx].piattaforma = piattaforma;
        fatture[idx].stato = stato; fatture[idx].timestampUltimaModifica = now;
    } else {
        if (fatture.some(function(x) { return x.numeroFattura === numero && x.annoFiscale === annoFattura; })) { alert('Numero fattura gi√† esistente per questo anno fiscale.'); return; }
        fatture.push({ id: 'f_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5), numeroFattura: numero, dataFattura: data, importoLordo: roundFiscal(importo), marcaDaBollo: (bolloVal === 'auto') ? 'auto' : parseFloat(bolloVal), annoFiscale: annoFattura, piattaforma: piattaforma, stato: stato, timestampCreazione: now, timestampUltimaModifica: now });
    }
    saveFiscoFatture(fatture);
    document.getElementById('modalFattura').style.display = 'none';
    var sel = document.getElementById('fiscoAnnoSel');
    var anni = getAnniDisponibili();
    sel.innerHTML = anni.map(function(a) { return '<option value="' + a + '"' + (a === annoFattura ? ' selected' : '') + '>' + a + '</option>'; }).join('');
    renderFisco();
}

function richiestaEliminaFattura(id) {
    document.getElementById('eliminaFatturaId').value = id;
    document.getElementById('modalFiscoElimina').style.display = 'flex';
}

function confermaEliminaFattura() {
    var id = document.getElementById('eliminaFatturaId').value;
    saveFiscoFatture(loadFiscoFatture().filter(function(x) { return x.id !== id; }));
    document.getElementById('modalFiscoElimina').style.display = 'none';
    renderFisco();
}

function toggleFsServizio(on) {
    var nome = document.getElementById('fsNomeServizio');
    var url = document.getElementById('fsUrlServizio');
    var lblNome = document.getElementById('lblFsNome');
    var lblUrl = document.getElementById('lblFsUrl');
    nome.disabled = !on; nome.style.opacity = on ? '1' : '0.4';
    url.disabled = !on; url.style.opacity = on ? '1' : '0.4';
    lblNome.style.opacity = on ? '1' : '0.4';
    lblUrl.style.opacity = on ? '1' : '0.4';
}

function apriFiscoSettings() {
    var s = loadFiscoSettings();
    document.getElementById('fsAnno').value = s.annoFiscaleAttivo;
    document.getElementById('fsCoeff').value = s.coefficiente;
    document.getElementById('fsImposta').value = s.aliquotaImposta;
    document.getElementById('fsINPS').value = s.aliquotaINPS;
    document.getElementById('fsRidINPS').checked = s.riduzioneINPS;
    document.getElementById('fsInpsVers').value = s.inpsVersato || 0;
    document.getElementById('fsChiuso').value = s.annoFiscaleChiuso ? 'true' : 'false';
    document.getElementById('fsUsaServizio').checked = s.usaServizioEsterno || false;
    document.getElementById('fsNomeServizio').value = s.nomeServizio || '';
    document.getElementById('fsUrlServizio').value = s.urlServizio || '';
    toggleFsServizio(s.usaServizioEsterno || false);
    document.getElementById('modalFiscoSettings').style.display = 'flex';
}

function salvaFiscoSettings() {
    var anno = parseInt(document.getElementById('fsAnno').value);
    var coeff = parseFloat(document.getElementById('fsCoeff').value);
    var imp = parseFloat(document.getElementById('fsImposta').value);
    var inps = parseFloat(document.getElementById('fsINPS').value);
    var ridINPS = document.getElementById('fsRidINPS').checked;
    var inpsVers = parseFloat(document.getElementById('fsInpsVers').value) || 0;
    var chiuso = document.getElementById('fsChiuso').value === 'true';
    var usaServ = document.getElementById('fsUsaServizio').checked;
    var nomeServ = document.getElementById('fsNomeServizio').value.trim();
    var urlServ = document.getElementById('fsUrlServizio').value.trim();
    if (isNaN(coeff) || coeff < 40 || coeff > 86) { alert('Coefficiente deve essere tra 40 e 86.'); return; }
    if (isNaN(imp) || imp < 5 || imp > 15) { alert('Imposta sostitutiva deve essere tra 5 e 15.'); return; }
    if (isNaN(inps) || inps < 20 || inps > 30) { alert('INPS deve essere tra 20 e 30.'); return; }
    if (inpsVers < 0) { alert('INPS versato non pu√≤ essere negativo.'); return; }
    if (usaServ && (!nomeServ || !urlServ)) { alert('Inserisci nome e URL del servizio esterno.'); return; }
    var old = loadFiscoSettings();
    saveFiscoSettings({ coefficiente: coeff, aliquotaImposta: imp, aliquotaINPS: inps, riduzioneINPS: ridINPS, inpsVersato: inpsVers, annoFiscaleAttivo: anno, annoFiscaleChiuso: chiuso, usaServizioEsterno: usaServ, nomeServizio: nomeServ, urlServizio: urlServ }, old);
    document.getElementById('modalFiscoSettings').style.display = 'none';
    var sel = document.getElementById('fiscoAnnoSel');
    var anni = getAnniDisponibili();
    sel.innerHTML = anni.map(function(a) { return '<option value="' + a + '"' + (a === anno ? ' selected' : '') + '>' + a + '</option>'; }).join('');
    renderFisco();
}

function backupFiscale() {
    var data = { fatture: loadFiscoFatture(), settings: loadFiscoSettings(), exportedAt: new Date().toISOString() };
    localStorage.setItem(FISCO_BACKUP_KEY, JSON.stringify(data));
    var blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url;
    a.download = 'fisco_backup_' + new Date().toISOString().split('T')[0] + '.json';
    a.click();
    URL.revokeObjectURL(url);
}

function checkFiscalIntegrity() {
    var fatture = loadFiscoFatture();
    var issues = [];
    fatture.forEach(function(f) {
        if (!f.id) issues.push('Fattura senza ID');
        if (!f.numeroFattura) issues.push('Fattura ' + f.id + ' senza numero');
        if (!f.dataFattura) issues.push('Fattura ' + f.id + ' senza data');
        if (f.importoLordo <= 0) issues.push('Fattura ' + f.id + ': importo <= 0');
        if (!['da_verificare', 'verificata'].includes(f.stato)) issues.push('Fattura ' + f.id + ': stato non valido');
    });
    return issues;
}

function stampaArchivioFiscale(anno, mese) {
    var fatture = loadFiscoFatture().filter(function(f) {
        if (f.annoFiscale !== anno) return false;
        if (mese !== undefined) return parseInt(f.dataFattura.split('-')[1]) === mese;
        return true;
    });
    var settings = loadFiscoSettings();
    var calc = calcolaFiscale(fatture, settings);
    var w = window.open('', '_blank');
    w.document.write('<html><head><title>Archivio Fiscale ' + anno + '</title><style>body{font-family:sans-serif;padding:20px;}table{width:100%;border-collapse:collapse;margin-bottom:20px;}th,td{border:1px solid #000;padding:6px;font-size:12px;}th{background:#eee;font-weight:bold;}</style></head><body>');
    w.document.write('<h2>ARCHIVIO FISCALE ' + anno + (mese ? ' - Mese ' + mese : '') + '</h2>');
    w.document.write('<table><thead><tr><th>N¬∞</th><th>Data</th><th>Piattaforma</th><th>Importo</th><th>Bollo</th><th>Stato</th></tr></thead><tbody>');
    fatture.slice().sort(function(a, b) { return a.dataFattura.localeCompare(b.dataFattura); }).forEach(function(f) {
        var b = (f.marcaDaBollo === 'auto' || f.marcaDaBollo === undefined) ? (f.importoLordo > 77.47 ? 2 : 0) : (parseFloat(f.marcaDaBollo) || 0);
        w.document.write('<tr><td>' + f.numeroFattura + '</td><td>' + formatDataFattura(f.dataFattura) + '</td><td>' + f.piattaforma + '</td><td>‚Ç¨ ' + f.importoLordo.toFixed(2) + '</td><td>‚Ç¨ ' + b.toFixed(2) + '</td><td>' + f.stato + '</td></tr>');
    });
    w.document.write('</tbody></table><table><tr><th>Lordo Totale</th><td>‚Ç¨ ' + calc.lordo.toFixed(2) + '</td></tr><tr><th>Reddito Imponibile</th><td>‚Ç¨ ' + calc.redditoImponibile.toFixed(2) + '</td></tr><tr><th>INPS</th><td>‚Ç¨ ' + calc.inps.toFixed(2) + '</td></tr><tr><th>Imposta Sostitutiva</th><td>‚Ç¨ ' + calc.imposta.toFixed(2) + '</td></tr><tr><th>Bolli Totali</th><td>‚Ç¨ ' + calc.totaleBolli.toFixed(2) + '</td></tr><tr><th>Netto Reale</th><td>‚Ç¨ ' + calc.nettoReale.toFixed(2) + '</td></tr><tr><th>Accantonamento (30%)</th><td>‚Ç¨ ' + calc.accantonamento.toFixed(2) + '</td></tr></table>');
    w.document.write('<p style="font-size:10px;color:#666;">Questo strumento √® un simulatore fiscale basato sui dati inseriti manualmente. Non sostituisce il commercialista.</p></body></html>');
    w.document.close();
    w.print();
}
</script>
</body>
</html>